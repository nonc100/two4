<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cosmos · 전체 차트</title>
  <style>
    :root{ color-scheme: dark; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial; background:#0e1220; color:#e8e8e8; }
    .wrap{ max-width: 1100px; margin: 0 auto; padding: 16px; }
    .topbar{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
    .back{ padding:8px 12px; border:1px solid rgba(255,255,255,.12); background:#12162a; color:#fff; border-radius:8px; text-decoration:none;}
    .coin-head{ display:flex; align-items:center; gap:12px; }
    .coin-head img{ width:32px; height:32px; border-radius:50%; object-fit:contain; }
    .muted{ opacity:.75; }
    .stat{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
    .card{ background:#11162a; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:12px 0; }
    .toolbar button, .toolbar select{
      padding:8px 10px; border:1px solid rgba(255,255,255,.12); background:#12162a; color:#fff; border-radius:8px; cursor:pointer;
    }
    .toolbar button.active{ background:#1f5cff; }
    .chart{ width:100%; height:60vh; min-height:300px; display:flex; align-items:center; justify-content:center;
            background:#0f1428; border:1px solid rgba(255,255,255,.08); border-radius:12px; }
    .price-up{ color:#28e07a; } .price-down{ color:#ff5b6e; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <a href="./index.html" class="back">← 목록으로</a>
    <div class="coin-head">
      <img id="coin-image" alt="">
      <div>
        <div id="coin-title" style="font-size:20px; font-weight:700;">-</div>
        <div id="coin-sub" class="muted">-</div>
      </div>
    </div>
  </div>

  <div class="stat">
    <div class="card">가격: <b id="stat-price">-</b></div>
    <div class="card">24h: <b id="stat-24h">-</b></div>
    <div class="card">시총: <b id="stat-mcap">-</b></div>
    <div class="card">거래량: <b id="stat-vol">-</b></div>
  </div>

  <div class="toolbar">
    기간:
    <button data-days="1">1D</button>
    <button data-days="7">7D</button>
    <button data-days="30" class="active">30D</button>
    <button data-days="90">90D</button>
    <button data-days="365">1Y</button>
    <button data-days="max">MAX</button>
    <span class="muted" style="margin-left:8px;">통화: </span>
    <select id="vs">
      <option value="usd" selected>USD</option>
      <!-- 필요하면 KRW 추가 가능: <option value="krw">KRW</option> -->
    </select>
  </div>

  <div id="chart" class="chart">Loading…</div>
</div>

<script>
/* ----- 안전한 숫자 포맷 (전역 패치) ----- */
(() => {
  const origToLS = Number.prototype.toLocaleString;
  Number.prototype.toLocaleString = function (locale, opts){
    if (opts && typeof opts === "object"){
      let {minimumFractionDigits:min, maximumFractionDigits:max} = opts;
      if (!Number.isFinite(min)) min = undefined;
      if (!Number.isFinite(max)) max = undefined;
      if (min !== undefined) min = Math.min(20, Math.max(0, min));
      if (max !== undefined) max = Math.min(20, Math.max(0, max));
      if (min !== undefined && max !== undefined && max < min) max = min;
      opts = {...opts, ...(min!==undefined?{minimumFractionDigits:min}:{}) , ...(max!==undefined?{maximumFractionDigits:max}:{})};
    }
    return origToLS.call(this, locale || "en-US", opts);
  };
})();
const fmtNum = (v, d=0)=> Number(v||0).toLocaleString("en-US",{minimumFractionDigits:d, maximumFractionDigits:d});
const fmtPrice = (v)=> {
  if (v == null) return "-";
  let d = v>=100?2 : v>=1?4 : Math.ceil(Math.abs(Math.log10(v)))+2;
  d = Math.max(0, Math.min(8, d));
  return Number(v).toLocaleString("en-US",{minimumFractionDigits:0, maximumFractionDigits:d});
};
const pct = (v)=> {
  if (v == null || !isFinite(v)) return "-";
  const n = Number(v).toFixed(2);
  const cls = n>0 ? 'price-up' : n<0 ? 'price-down' : '';
  return `<span class="${cls}">${n>0?'+':''}${n}%</span>`;
};

/* ----- API 헬퍼 (직접 → 프록시 폴백) ----- */
async function getJSON(url, proxyUrl){
  try{
    const r = await fetch(url); if(!r.ok) throw new Error(r.status);
    return await r.json();
  }catch{
    const r2 = await fetch(proxyUrl); if(!r2.ok) throw new Error('proxy '+r2.status);
    return await r2.json();
  }
}
async function fetchCoinMeta(id){
  const q = 'localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false';
  return getJSON(
    `https://api.coingecko.com/api/v3/coins/${id}?${q}`,
    `/api/coins/${id}?${q}`
  );
}
async function fetchCoinChart(id, vs='usd', days='30'){
  const q = `vs_currency=${vs}&days=${days}`;
  return getJSON(
    `https://api.coingecko.com/api/v3/coins/${id}/market_chart?${q}`,
    `/api/coins/${id}/market_chart?${q}`
  );
}

/* ----- SVG 라인 차트 ----- */
function lineSVG(prices, w=1000, h= Math.max(260, Math.round(window.innerHeight*0.55))){
  if(!prices || prices.length<2) return 'No data';
  const arr = Array.isArray(prices[0]) ? prices.map(p=>p[1]) : prices;
  const min = Math.min(...arr), max = Math.max(...arr);
  const span = (max-min) || 1;
  const pts = arr.map((p,i)=>{
    const x = (i/(arr.length-1))*w;
    const y = h - ((p-min)/span)*h;
    return `${x.toFixed(1)},${y.toFixed(1)}`
  }).join(' ');
  const up = arr.at(-1) >= arr[0];
  const color = up ? '#28e07a' : '#ff5b6e';

  // 그리드(가벼운 보조선)
  const grid = [];
  const rows = 4, cols = 6;
  for(let i=1;i<rows;i++){
    const y = (i/rows)*h; grid.push(`<line x1="0" y1="${y}" x2="${w}" y2="${y}" stroke="rgba(255,255,255,.06)"/>`);
  }
  for(let i=1;i<cols;i++){
    const x = (i/cols)*w; grid.push(`<line x1="${x}" y1="0" x2="${x}" y2="${h}" stroke="rgba(255,255,255,.06)"/>`);
  }

  return `<svg width="100%" height="${h}" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
    ${grid.join('')}
    <polyline fill="none" stroke="${color}" stroke-width="2" points="${pts}"/>
  </svg>`;
}

/* ----- 페이지 로직 ----- */
const params = new URLSearchParams(location.search);
const id = params.get('id');

const $ = s => document.querySelector(s);
async function load(days='30'){
  if(!id){ $('#chart').textContent = '코인 ID가 없습니다.'; return; }

  // 메타
  try{
    const meta = await fetchCoinMeta(id);
    $('#coin-image').src = meta.image?.small || meta.image?.thumb || '';
    $('#coin-title').textContent = `${meta.name} (${(meta.symbol||'').toUpperCase()})`;
    const m = meta.market_data || {};
    $('#coin-sub').textContent = `Rank #${meta.market_cap_rank ?? '-'}`;
    $('#stat-price').innerHTML = '$' + fmtPrice(m.current_price?.usd);
    $('#stat-24h').innerHTML = pct(m.price_change_percentage_24h_in_currency?.usd ?? m.price_change_percentage_24h);
    $('#stat-mcap').innerHTML = '$' + fmtNum(m.market_cap?.usd, 0);
    $('#stat-vol').innerHTML = '$' + fmtNum(m.total_volume?.usd, 0);
  }catch(e){
    console.error(e);
  }

  // 차트
  $('#chart').textContent = 'Loading…';
  const vs = $('#vs').value || 'usd';
  try{
    const data = await fetchCoinChart(id, vs, days);
    $('#chart').innerHTML = lineSVG(data.prices);
  }catch(e){
    $('#chart').innerHTML = `<div style="color:#ff6b6b">차트 로딩 실패: ${e}</div>`;
  }
}

/* ----- UI 바인딩 ----- */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-days]');
  if(!btn) return;
  document.querySelectorAll('button[data-days]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  load(btn.getAttribute('data-days'));
});
$('#vs').addEventListener('change', ()=> {
  const active = document.querySelector('button[data-days].active');
  load(active ? active.getAttribute('data-days') : '30');
});

/* start */
load('30');
</script>
</body>
</html>
