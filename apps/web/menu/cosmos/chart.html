<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>COSMOS Chart</title>
  <style>
    :root{ --bg:#0b1018; --text:#e8eefc; --muted:#9aa3b6; --up:#22c55e; --down:#ef4444; --star:0; --bgstar:0; --topbar-h:56px; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(1200px 600px at 50% 0%, #182036 0%, var(--bg) 60%); color:var(--text); font:14px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic","Helvetica Neue",Arial; height:100%}
    body{overflow:hidden}

    .sky{position:fixed; inset:0; pointer-events:none; z-index:0;}
    .stars,.stars2,.stars3{position:absolute; inset:0; background-repeat:repeat; background-size:1600px 1600px; animation:twinkle 18s linear infinite; opacity:.55; filter:blur(.2px)}
    .stars{background-image:radial-gradient(1px 1px at 20px 30px,#fff8 50%,transparent 51%),radial-gradient(1px 1px at 120px 80px,#fff8 50%,transparent 51%),radial-gradient(1px 1px at 300px 120px,#fff8 50%,transparent 51%)}
    .stars2{background-image:radial-gradient(1px 1px at 40px 60px,#fff6 50%,transparent 51%),radial-gradient(1px 1px at 220px 140px,#fff6 50%,transparent 51%),radial-gradient(1px 1px at 460px 240px,#fff6 50%,transparent 51%); animation-duration:26s; opacity:.35}
    .stars3{background-image:radial-gradient(1px 1px at 70px 20px,#fff5 50%,transparent 51%),radial-gradient(1px 1px at 260px 220px,#fff5 50%,transparent 51%),radial-gradient(1px 1px at 520px 420px,#fff5 50%,transparent 51%); animation-duration:34s; opacity:.25}
    @keyframes twinkle{from{background-position:0 0} to{background-position:-1600px -1600px}}
    .white-stars{position:fixed; inset:0; z-index:0; pointer-events:none; opacity:var(--bgstar,0)}

    .topbar{position:fixed; top:calc(env(safe-area-inset-top) + 8px); left:12px; right:12px; z-index:7; display:flex; align-items:center; justify-content:space-between; gap:10px}
    .back-btn{width:42px; height:42px; border-radius:999px; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.04)); border:1px solid rgba(255,255,255,.18); color:#dbeafe; font-size:18px}
    .meta{display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px)}
    .meta img{width:18px; height:18px; border-radius:50%}
    .meta .nm{font-weight:900; letter-spacing:.02em}
    .periods{display:flex; gap:6px}
    .periods button{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); color:#e8eefc; padding:6px 9px; border-radius:8px; font-weight:700}
    .periods button.on{background:rgba(114,153,255,.16); border-color:rgba(114,153,255,.32)}

    .stage{position:fixed; inset:0; padding-top:calc(var(--topbar-h) + env(safe-area-inset-top) + 16px); padding-bottom:8px}
    .chart{position:absolute; left:0; right:0; top:calc(var(--topbar-h) + env(safe-area-inset-top) + 16px); bottom:8px}
    canvas{position:absolute; inset:0; width:100%; height:100%}

    @media (max-width:767px){.back-btn{width:38px;height:38px}}
  </style>
</head>
<body>
  <div class="sky"><div class="stars"></div><div class="stars2"></div><div class="stars3"></div></div>
  <canvas id="whiteStars" class="white-stars" aria-hidden="true"></canvas>

  <div class="topbar" id="topbar">
    <button class="back-btn" id="backBtn" title="뒤로가기">⬅</button>
    <div class="meta"><img id="coinImg" alt=""><span class="nm" id="coinNm">-</span> <span id="coinPrice" style="font-variant-numeric:tabular-nums;font-weight:900"></span></div>
    <div class="periods">
      <button data-days="1">1D</button>
      <button data-days="7" class="on">7D</button>
      <button data-days="30">30D</button>
      <button data-days="90">90D</button>
      <button data-days="365">1Y</button>
      <button data-days="max">MAX</button>
    </div>
  </div>

  <div class="stage">
    <div class="chart"><canvas id="chart"></canvas></div>
  </div>

  <script>
    const StarField=(()=>{let cv,ctx,stars=[],intensity=0,animId=null,W=0,H=0,dpr=1;const D=140,TW_MIN=.002,TW_MAX=.006,R_MIN=.3,R_MAX=1.1,rand=(a,b)=>a+Math.random()*(b-a);function resize(){if(!cv)return;dpr=window.devicePixelRatio||1;const vw=innerWidth,vh=innerHeight;W=Math.floor(vw*dpr);H=Math.floor(vh*dpr);cv.width=W;cv.height=H;cv.style.width=vw+"px";cv.style.height=vh+"px";build()}function build(){const area=(W*H)/(dpr*dpr),target=Math.floor(area/100000*D*intensity),cur=stars.length; if(cur<target){for(let i=cur;i<target;i++)stars.push({x:Math.random()*W,y:Math.random()*H,r:(R_MIN+(R_MAX-R_MIN)*Math.random())*dpr,a:.35+.55*Math.random(),tw:TW_MIN+(TW_MAX-TW_MIN)*Math.random(),ph:Math.random()*Math.PI*2})}else if(cur>target){stars.splice(target)}}
    function loop(){if(!ctx)return;ctx.clearRect(0,0,W,H);const base=intensity;for(const s of stars){s.ph+=s.tw;const a=base*(.85+.15*Math.sin(s.ph));ctx.globalAlpha=a*s.a;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fillStyle="#fff";ctx.fill()}ctx.globalAlpha=1;animId=requestAnimationFrame(loop)}
    function setIntensity(v){intensity=Math.max(0,Math.min(1,v));document.documentElement.style.setProperty("--bgstar",String(intensity));build(); if(intensity>0&&!animId)animId=requestAnimationFrame(loop); if(intensity===0&&animId){cancelAnimationFrame(animId);animId=null;ctx.clearRect(0,0,W,H)}}
    function init(){cv=document.getElementById("whiteStars"); if(!cv) return; ctx=cv.getContext("2d"); resize(); addEventListener("resize",resize)}
    return{init,setIntensity};})();
    StarField.init(); StarField.setIntensity((Number(localStorage.getItem("two4_star")||0))/100);

    const $=s=>document.querySelector(s), setHTML=(el,html)=>{const n=typeof el==="string"?$(el):el; if(n) n.innerHTML=html;};
    const clamp=(n,a,b)=>Math.min(b,Math.max(a,n));
    const safeLocale=(num,min=0,max=2)=>{if(max<min)max=min; try{return Number(num??0).toLocaleString('en-US',{minimumFractionDigits:min,maximumFractionDigits:max});}catch{return String(Number(num??0).toFixed(max));}};
    const fmtPrice=v=>v==null||Number.isNaN(v)?"-":"$"+safeLocale(v,0,2);

    const params=new URLSearchParams(location.search); const id=params.get("id")||"bitcoin";
    $("#backBtn").addEventListener("click",()=>history.back());

    function applyTopbarHeight(){const bar=$("#topbar"); if(!bar)return; const h=Math.ceil(bar.getBoundingClientRect().height); document.documentElement.style.setProperty('--topbar-h', h+'px');}
    addEventListener('resize', applyTopbarHeight, {passive:true});
    applyTopbarHeight();

    const cv=document.getElementById("chart"); const ctx=cv.getContext("2d");
    function resizeCanvas(){const dpr=window.devicePixelRatio||1, w=innerWidth, h=innerHeight - (parseInt(getComputedStyle(document.querySelector(".stage")).paddingTop)||60) - 8; cv.width=w*dpr; cv.height=h*dpr; cv.style.width=w+"px"; cv.style.height=h+"px"; ctx.setTransform(dpr,0,0,dpr,0,0);}
    addEventListener("resize", resizeCanvas);

    async function fetchMarketsById(id){
      const q=`vs_currency=usd&ids=${encodeURIComponent(id)}&sparkline=false&price_change_percentage=24h`;
      const d=`https://api.coingecko.com/api/v3/coins/markets?${q}`, p=`/api/coins/markets?${q}`;
      try{const r=await fetch(d); if(!r.ok) throw 0; return await r.json();}catch{const r2=await fetch(p); if(!r2.ok) throw new Error("mk failed"); return await r2.json();}
    }
    async function fetchChart(id, days){
      const q=`vs_currency=usd&days=${days}`, d=`https://api.coingecko.com/api/v3/coins/${encodeURIComponent(id)}/market_chart?${q}`, p=`/api/coins/${encodeURIComponent(id)}/market_chart?${q}`;
      try{const r=await fetch(d); if(!r.ok) throw 0; return await r.json();}catch{const r2=await fetch(p); if(!r2.ok) throw new Error("chart failed"); return await r2.json();}
    }

    function drawLine(prices){
      resizeCanvas();
      const w=cv.width/(window.devicePixelRatio||1), h=cv.height/(window.devicePixelRatio||1);
      ctx.clearRect(0,0,w,h);
      if(!prices || prices.length<2) return;
      const arr=prices.map(p=>p[1]);
      const min=Math.min(...arr), max=Math.max(...arr), span=(max-min)||1;
      const m=18, x0=m, x1=w-m, y0=h-m, y1=m, ww=x1-x0, hh=y0-y1;

      ctx.globalAlpha=0.25; ctx.strokeStyle="rgba(255,255,255,.25)"; ctx.lineWidth=1;
      for(let i=0;i<=4;i++){const y=y0 - hh*(i/4); ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();}
      ctx.globalAlpha=1;

      const up=arr.at(-1)>=arr[0]; ctx.strokeStyle=up?"#22c55e":"#ef4444"; ctx.lineWidth=2.2; ctx.beginPath();
      prices.forEach((p,i)=>{const x=x0 + ww*(i/(prices.length-1)); const y=y0 - hh*((p[1]-min)/span); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);});
      ctx.stroke();

      const g=ctx.createLinearGradient(0,y1,0,y0); g.addColorStop(0, (up?"rgba(34,197,94,.28)":"rgba(239,68,68,.28)")); g.addColorStop(1,"rgba(255,255,255,0)");
      ctx.fillStyle=g; ctx.lineTo(x1,y0); ctx.lineTo(x0,y0); ctx.closePath(); ctx.fill();
    }

    async function loadMeta(){
      try{
        const [info]=await fetchMarketsById(id);
        if(info){ $("#coinImg").src=info.image; $("#coinImg").alt=info.symbol?.toUpperCase()||""; $("#coinNm").textContent=(info.symbol||"").toUpperCase(); $("#coinPrice").textContent=" · "+fmtPrice(info.current_price); }
      }catch{}
    }
    async function loadChart(days="7"){ try{ const data=await fetchChart(id, days); drawLine(data?.prices||[]);}catch{drawLine([]);} }

    document.querySelectorAll(".periods button").forEach(b=>{
      b.addEventListener("click", async ()=>{
        document.querySelectorAll(".periods button").forEach(x=>x.classList.remove("on"));
        b.classList.add("on");
        await loadChart(b.dataset.days);
      });
    });

    (async function init(){ await loadMeta(); await loadChart("7"); })();
  </script>
</body>
</html>
