<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>COSMOS Chart</title>
<style>
  :root{
    --bg:#0b1018; --panel:#0f172a; --grid:#223047; --text:#e8eefc; --muted:#9aa3b6;
    --up:#22c55e; --down:#ef4444; --accent:#7efcf3;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto}
  .wrap{position:fixed; inset:0; display:flex; flex-direction:column}
  .topbar{
    height:48px; display:flex; gap:10px; align-items:center; padding:8px 10px;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .title{font-weight:800; letter-spacing:.04em; margin-right:auto}
  select,button,input{
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
    color:var(--text); border-radius:8px; padding:6px 8px; outline:none
  }
  .chk{display:flex;align-items:center;gap:6px}
  #chart{flex:1; display:block; width:100%; height:calc(100% - 48px); background:var(--panel)}
  .legend{position:fixed; right:8px; top:52px; font-size:12px; background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.12); padding:6px 8px; border-radius:8px}
  .legend b{font-weight:900}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title" id="ttl">—</div>
    <label>간격
      <select id="interval">
        <option>1m</option><option>5m</option><option>15m</option>
        <option selected>1h</option><option>4h</option><option>1d</option>
      </select>
    </label>
    <label class="chk"><input type="checkbox" id="vwma20" checked>VWMA20</label>
    <label class="chk"><input type="checkbox" id="vwma50">VWMA50</label>
    <button id="refresh">새로고침</button>
  </div>
  <canvas id="chart"></canvas>
  <div class="legend" id="legend">—</div>
</div>

<script>
(function(){
  // ====== Helpers ======
  const $ = sel => document.querySelector(sel);
  const params = new URLSearchParams(location.search);
  const SYMBOL = (params.get('symbol') || 'BTCUSDT').toUpperCase();
  const DEF_INTERVAL = params.get('interval') || '1h';
  $('#interval').value = DEF_INTERVAL;
  $('#ttl').textContent = `${SYMBOL} · Binance`;

  function toNum(x){ return typeof x==='number' ? x : Number(x); }
  function vwma(closes, vols, n){
    const out = Array(closes.length).fill(null);
    let pv=0, v=0;
    for(let i=0;i<closes.length;i++){
      const p=closes[i], vol=vols[i];
      pv += p*vol; v += vol;
      if(i>=n){ // 윈도우 제외
        const p0 = closes[i-n], v0 = vols[i-n];
        pv -= p0*v0; v -= v0;
      }
      if(i>=n-1) out[i] = pv / (v||1);
    }
    return out;
  }

  async function fetchKlines(symbol, interval='1h', limit=500){
    const q = `symbol=${encodeURIComponent(symbol)}&interval=${interval}&limit=${limit}`;
    const directF = `https://fapi.binance.com/fapi/v1/klines?${q}`;
    const directS = `https://api.binance.com/api/v3/klines?${q}`;
    const proxF = `/api/binance/klines?${q}`;
    try{
      let r = await fetch(directF); if(!r.ok) throw 0; return await r.json();
    }catch{
      try{ let r2 = await fetch(directS); if(!r2.ok) throw 0; return await r2.json(); }
      catch{ let r3 = await fetch(proxF); if(!r3.ok) throw new Error('klines failed'); return await r3.json(); }
    }
  }

  // ====== Drawing ======
  const cvs = $('#chart'), ctx = cvs.getContext('2d');
  let W=0, H=0, DPR=1;
  function resize(){
    const r = window.devicePixelRatio || 1;
    DPR = r;
    W = cvs.clientWidth;
    H = cvs.clientHeight;
    cvs.width = Math.floor(W * DPR);
    cvs.height = Math.floor(H * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener('resize', ()=>{ resize(); if(current) draw(current); });

  function yScale(min,max,pad=0.08){
    const span = max-min; const p = span*pad;
    const lo = min - p, hi = max + p;
    const k = (H-30) / (hi-lo);
    return v => H-20 - (v-lo)*k;
  }
  function xScale(n){ const step = (W-16) / Math.max(1, n-1); return i => 8 + i*step; }

  function linePath(points){
    ctx.beginPath();
    for(let i=0;i<points.length;i++){
      const [x,y] = points[i];
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
  }
  function drawGrid(){
    ctx.strokeStyle='rgba(255,255,255,.08)';
    ctx.lineWidth=1;
    const rows=5;
    for(let i=0;i<=rows;i++){
      const y = 10 + (H-40)*i/rows;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
    }
  }

  function drawLegend(price, tStr){
    $('#legend').innerHTML = `<b>${SYMBOL}</b> · ${tStr} · ${price}`;
  }

  let current=null;
  function draw(data){
    const {t, close, vol, vw20, vw50} = data;
    ctx.clearRect(0,0,W,H);
    drawGrid();

    const min = Math.min(...close.filter(Boolean), ...(vw20.filter(Boolean)||[Infinity]), ...(vw50.filter(Boolean)||[Infinity]));
    const max = Math.max(...close.filter(Boolean), ...(vw20.filter(Boolean)||[-Infinity]), ...(vw50.filter(Boolean)||[-Infinity]));
    const Y = yScale(min,max), X = xScale(close.length);

    // 가격 라인
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#cfe9ff';
    linePath(close.map((p,i)=>[X(i), Y(p)]));
    ctx.stroke();

    // VWMA20
    if($('#vwma20').checked){
      ctx.lineWidth = 1.8;
      ctx.strokeStyle = '#7efcf3';
      ctx.shadowColor = '#7efcf3';
      ctx.shadowBlur = 6;
      linePath(vw20.map((p,i)=> p ? [X(i), Y(p)] : [X(i), Y(close[i])]));
      ctx.stroke();
      ctx.shadowBlur = 0;
    }
    // VWMA50
    if($('#vwma50').checked){
      ctx.lineWidth = 1.8;
      ctx.strokeStyle = '#a78bfa';
      ctx.shadowColor = '#a78bfa';
      ctx.shadowBlur = 6;
      linePath(vw50.map((p,i)=> p ? [X(i), Y(p)] : [X(i), Y(close[i])]));
      ctx.stroke();
      ctx.shadowBlur = 0;
    }

    // 볼륨(하단 1/5 높이)
    const vMax = Math.max(...vol);
    const vh = Math.max(40, H*0.18);
    const y0 = H - 10;
    ctx.fillStyle = 'rgba(255,255,255,.10)';
    const barW = Math.max(1, (W-16)/vol.length - 1);
    for(let i=0;i<vol.length;i++){
      const x = X(i) - barW/2;
      const h = (vol[i]/(vMax||1))*vh;
      ctx.fillRect(x, y0-h, barW, h);
    }

    // 마지막값 레전드
    const last = close.length-1;
    const lastPrice = close[last]?.toLocaleString('en-US',{maximumFractionDigits:8});
    const tStr = new Date(t[last]).toLocaleString();
    drawLegend(lastPrice||'-', tStr);
  }

  async function load(){
    $('#ttl').textContent = `${SYMBOL} · Binance`;
    const interval = $('#interval').value;
    const raw = await fetchKlines(SYMBOL, interval, 500);
    const t=[], close=[], vol=[];
    for(const k of raw){
      t.push(k[0]);
      close.push(toNum(k[4]));
      vol.push(toNum(k[5]));
    }
    const vw20 = vwma(close, vol, 20);
    const vw50 = vwma(close, vol, 50);
    current = {t, close, vol, vw20, vw50};
    resize(); draw(current);
  }

  // 이벤트
  $('#interval').addEventListener('change', load);
  $('#refresh').addEventListener('click', load);
  $('#vwma20').addEventListener('change', ()=>{ if(current){ draw(current); }});
  $('#vwma50').addEventListener('change', ()=>{ if(current){ draw(current); }});

  // 초기화
  load();
  // 60초마다 갱신 (무료/무인증 API 안전선)
  setInterval(()=>{ if(document.visibilityState==='visible') load(); }, 60000);
})();
</script>
</body>
</html>
