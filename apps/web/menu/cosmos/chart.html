<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cosmos · 전체 차트</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{ color-scheme:dark; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial; background:#0e1220; color:#e8e8e8; }
    .wrap{ max-width:1200px; margin:0 auto; padding:14px; }
    .top{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    .btn{ padding:8px 10px; border:1px solid rgba(255,255,255,.12); background:#12162a; color:#fff; border-radius:8px; cursor:pointer; text-decoration:none; }
    .btn.active{ background:#1f5cff; }
    .muted{ opacity:.75; }
       .grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    .panel{ background:#0f152b; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; }
    .stat{ display:flex; gap:10px; flex-wrap:wrap; }
    .card{ background:#11162a; border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:8px 10px; }
    .chart{ height:58vh; min-height:340px; }
    .subchart{ height:18vh; min-height:120px; }
  </style>
</head>
<body>
<div class="wrap">
 <div class="top">
    <a href="./index.html" class="btn">← 목록으로</a>
    <div id="title" style="font-weight:700;font-size:18px;">-</div>
    <div id="rank" class="muted">Rank -</div>
    <div style="flex:1"></div>
    <div class="muted">기간:</div>
    <button class="btn" data-days="1">1D</button>
    <button class="btn" data-days="7">7D</button>
    <button class="btn active" data-days="30">30D</button>
    <button class="btn" data-days="90">90D</button>
    <button class="btn" data-days="365">1Y</button>
    <button class="btn" data-days="max">MAX</button>
    <div class="muted" style="margin-left:6px;">통화:</div>
    <select id="vs" class="btn" style="padding:8px 10px;">
      <option value="usd" selected>USD</option>
      <!-- <option value="krw">KRW</option> -->
    </select>
  </div>

  <div class="stat">
      <div class="card">가격: <b id="s-price">-</b></div>
    <div class="card">24h: <b id="s-24h">-</b></div>
    <div class="card">시총: <b id="s-mcap">-</b></div>
    <div class="card">거래량: <b id="s-vol">-</b></div>
  </div>

 <div class="grid">
    <div class="panel"><div id="chart" class="chart"></div></div>
    <div class="panel"><div id="vol" class="subchart"></div></div>
  </div>
</div>

<script>
const params = new URLSearchParams(location.search);
const COIN_ID = params.get('id') || 'bitcoin';
const $ = s => document.querySelector(s);
const fmtNum = (v,d=0)=> Number(v||0).toLocaleString('en-US',{minimumFractionDigits:d, maximumFractionDigits:d});
const fmtPrice = (v)=>{ if(v==null) return "-"; let d=v>=100?2:v>=1?4:Math.ceil(Math.abs(Math.log10(v)))+2; d=Math.max(0,Math.min(8,d)); return Number(v).toLocaleString("en-US",{minimumFractionDigits:0, maximumFractionDigits:d}); };
const pct = (v)=>{ if(v==null||!isFinite(v)) return "-"; const n=Number(v).toFixed(2); const cls=n>0?'color:#28e07a':n<0?'color:#ff5b6e':''; return `<span style="${cls}">${n>0?'+':''}${n}%</span>`; };

async function getJSON(url, proxyUrl){ try{ const r=await fetch(url); if(!r.ok) throw new Error(r.status); return await r.json(); } catch{ const r2=await fetch(proxyUrl); if(!r2.ok) throw new Error('proxy '+r2.status); return await r2.json(); } }
async function fetchMeta(id){ const q='localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false'; return getJSON(`https://api.coingecko.com/api/v3/coins/${id}?${q}`, `/api/coins/${id}?${q}`); }
async function fetchOHLC(id, vs, days){ return getJSON(`https://api.coingecko.com/api/v3/coins/${id}/ohlc?vs_currency=${vs}&days=${days}`, `/api/coins/${id}/ohlc?vs_currency=${vs}&days=${days}`); }
async function fetchMarketChart(id, vs, days){ return getJSON(`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=${vs}&days=${days}`, `/api/coins/${id}/market_chart?vs_currency=${vs}&days=${days}`); }

function SMA(bars,len){ const out=[]; let sum=0; for(let i=0;i<bars.length;i++){ sum+=bars[i].close; if(i>=len) sum-=bars[i-len].close; if(i>=len-1) out.push({ time:bars[i].time, value:+(sum/len).toFixed(6)}); } return out; }

const chart = LightweightCharts.createChart($('#chart'), {
  layout:{ background:{ color:'#0f152b' }, textColor:'#D8DEE9' },
  grid:{ vertLines:{ color:'#1b2442' }, horzLines:{ color:'#1b2442' } },
  rightPriceScale:{ borderColor:'#334' }, timeScale:{ borderColor:'#334' },
  crosshair:{ mode: LightweightCharts.CrosshairMode.Normal },
});
const candleSeries = chart.addCandlestickSeries({ upColor:'#2ECC71', downColor:'#E74C3C', borderDownColor:'#E74C3C', borderUpColor:'#2ECC71', wickDownColor:'#E74C3C', wickUpColor:'#2ECC71' });
const ma7  = chart.addLineSeries({ color:'#4aa3ff', lineWidth:2 });
const ma25 = chart.addLineSeries({ color:'#ffcf5a', lineWidth:2 });

  const volChart = LightweightCharts.createChart($('#vol'), {
  layout:{ background:{ color:'#0f152b' }, textColor:'#D8DEE9' },
  grid:{ vertLines:{ color:'#1b2442' }, horzLines:{ color:'#1b2442' } },
  rightPriceScale:{ borderColor:'#334' }, timeScale:{ borderColor:'#334' },
  crosshair:{ mode: LightweightCharts.CrosshairMode.Normal },
});
const volSeries = volChart.addHistogramSeries({ priceFormat:{ type:'volume' }, color:'#6f88ff' });
  
async function load(days='30'){
  const vs = $('#vs').value || 'usd';
try{
        const meta = await fetchMeta(COIN_ID);
    $('#title').textContent = `${(meta.symbol||'').toUpperCase()} · ${meta.name}`;
    $('#rank').textContent  = `Rank #${meta.market_cap_rank ?? '-'}`;
    const m = meta.market_data || {};
    $('#s-price').innerHTML = '$' + fmtPrice(m.current_price?.[vs]);
    $('#s-24h').innerHTML   = pct(m.price_change_percentage_24h_in_currency?.[vs] ?? m.price_change_percentage_24h);
    $('#s-mcap').innerHTML  = '$' + fmtNum(m.market_cap?.[vs], 0);
    $('#s-vol').innerHTML   = '$' + fmtNum(m.total_volume?.[vs], 0);
  }catch(e){ console.warn('meta fail', e); }

  try{
    const raw = await fetchOHLC(COIN_ID, vs, days);
    const bars = raw.map(([t,o,h,l,c]) => ({ time: Math.floor(t/1000), open:o, high:h, low:l, close:c }));
    candleSeries.setData(bars);
    ma7.setData(SMA(bars, 7));
    ma25.setData(SMA(bars, 25));
    chart.timeScale().fitContent();
  }catch(e){ candleSeries.setData([]); ma7.setData([]); ma25.setData([]); console.error('ohlc fail', e); }

  try{
        const mc = await fetchMarketChart(COIN_ID, vs, days);
    const vols = mc.total_volumes.map(([t, v]) => ({ time: Math.floor(t/1000), value: v, color: '#6f88ff' }));
    volSeries.setData(vols);
    volChart.timeScale().fitContent();
  }catch(e){ volSeries.setData([]); console.error('volume fail', e); }
}

document.addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-days]'); if(!b) return;
  document.querySelectorAll('button[data-days]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); load(b.getAttribute('data-days'));
});
$('#vs').addEventListener('change', ()=> {
  const active = document.querySelector('button[data-days].active');
  load(active ? active.getAttribute('data-days') : '30');
});

load('30');
</script>
</body>
</html>
