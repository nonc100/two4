<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>COSMOS ‚Ä¢ Chart</title>
<script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root{
  --bg:#0b1018;
  --panel:#111827;
  --text:#e8eefc;
  --muted:#9aa3b6;
  --glass:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  --card-border:rgba(255,255,255,.12);
  --green:#22c55e; --red:#ef4444; --neon:#7c6cff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 50% -80px,#182036 0%,var(--bg) 60%);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
.wrap{min-height:100svh;display:flex;flex-direction:column;gap:10px;padding:10px 10px 18px}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{margin:0;font-size:20px;letter-spacing:.18em;opacity:.9}
.toolbar{
  position:sticky; top:0; z-index:5;
  display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center;
  padding:8px; border:1px solid var(--card-border); border-radius:12px; background:var(--glass); backdrop-filter:blur(14px)
}
.toolbar .chip{display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid var(--card-border); border-radius:999px; background:rgba(255,255,255,.06)}
.toolbar input,.toolbar select{background:rgba(255,255,255,.06); border:1px solid var(--card-border); color:var(--text); border-radius:8px; padding:6px 8px; outline:none}
.btn{padding:6px 10px; border-radius:999px; border:1px solid var(--card-border); background:rgba(255,255,255,.06); color:var(--text); font-weight:700; cursor:pointer}
.btn.on{background:rgba(124,108,255,.18); border-color:rgba(124,108,255,.36)}
.chart-card{
  position:relative; flex:1 1 auto; min-height:calc(100svh - 180px);
  border:1px solid var(--card-border); border-radius:16px; background:var(--glass); box-shadow:0 10px 30px rgba(0,0,0,.25);
  overflow:hidden;
}
#chart{position:absolute; inset:0}
.legend{
  position:absolute; left:10px; top:10px; z-index:4; display:flex; gap:10px; flex-wrap:wrap
}
.legend .tag{padding:4px 8px; border-radius:999px; background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.18); font-size:12px}
.footer{opacity:.7; text-align:center; margin-top:8px; font-size:12px}
@media (max-width:768px){
  .toolbar{justify-content:center}
  .chart-card{min-height:calc(100svh - 200px)}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="brand"><h1>TWO4 ‚Ä¢ COSMOS</h1></div>

  <!-- Ìà¥Î∞î -->
  <div class="toolbar" id="toolbar">
    <div class="chip">
      Ïã¨Î≥º:
      <input id="sym" placeholder="BTCUSDT" style="width:110px" />
      <button class="btn" id="goBtn">Ïó¥Í∏∞</button>
    </div>

    <div class="chip">
      TF:
      <button class="btn tf on" data-i="15m">15m</button>
      <button class="btn tf" data-i="1h">1h</button>
      <button class="btn tf" data-i="4h">4h</button>
      <button class="btn tf" data-i="1d">1d</button>
    </div>

    <div class="chip">
      ÏÑ§Ï†ï:
      <label>RSI <input id="rsiLen" type="number" min="2" max="100" step="1" style="width:64px" /></label>
      <label>OI
        <select id="oiPeriod">
          <option>5m</option><option>15m</option><option>30m</option>
          <option>1h</option><option>2h</option><option>4h</option>
          <option>6h</option><option>12h</option><option>1d</option>
        </select>
      </label>
    </div>

    <div class="chip">
      Î≥¥Í∏∞:
      <button class="btn" id="fitBtn">Fit</button>
      <button class="btn" id="resetBtn">Reset</button>
    </div>
  </div>

  <!-- Ï∞®Ìä∏ -->
  <div class="chart-card">
    <div class="legend" id="legend"></div>
    <div id="chart"></div>
  </div>

  <div class="footer">üìà Binance Klines / OI ¬∑ RSI & OI ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï ¬∑ Î™®Î∞îÏùº ÌïÄÏπò/Ïä§ÌÅ¨Î°§ ÌôïÎåÄÏù¥Îèô</div>
</div>

<script>
/* ========= helpers ========= */
const qs = new URLSearchParams(location.search);
const COIN_ID_TO_SYM = {
  bitcoin:'BTCUSDT', ethereum:'ETHUSDT', tether:'USDTUSD',
  bnb:'BNBUSDT', solana:'SOLUSDT', ripple:'XRPUSDT',
  cardano:'ADAUSDT', dogecoin:'DOGEUSDT', 'usd-coin':'USDCUSDT'
};
function guessSymbol(){ // ?sym Ïö∞ÏÑ†, ?id ÏùºÎ∂Ä Îß§Ìïë, Ïã§Ìå® Ïãú BTCUSDT
  const sym = (qs.get('sym')||'').toUpperCase().replace(/[^A-Z0-9]/g,'');
  if(sym) return sym;
  const id = (qs.get('id')||'').toLowerCase();
  if(COIN_ID_TO_SYM[id]) return COIN_ID_TO_SYM[id];
  // idÍ∞Ä Ïã¨Î≥ºÎ°ú Îì§Ïñ¥Ïò® Í≤ΩÏö∞(Ïòà: btc) Ï≤òÎ¶¨
  if(id && id.length<=6) return id.toUpperCase()+'USDT';
  return 'BTCUSDT';
}
const clamp=(n,a,b)=>Math.min(b,Math.max(a,n));
async function fetchJSON(primary, fallback){
  try{
    const r = await fetch(primary);
    if(!r.ok) throw 0;
    return await r.json();
  }catch{
    const r2 = await fetch(fallback);
    if(!r2.ok) throw new Error('fetch failed');
    return await r2.json();
  }
}
function toSec(ms){ return Math.floor(ms/1000); }

/* ========= indicator: RSI ========= */
function calcRSI(points, length=14){
  if(!Array.isArray(points)||points.length<length+1) return [];
  const out=[]; let gains=0, losses=0;
  for(let i=1;i<=length;i++){
    const ch = points[i].close - points[i-1].close;
    gains += Math.max(0,ch);
    losses+= Math.max(0,-ch);
  }
  let avgG = gains/length, avgL = losses/length;
  out.push({ time: points[length].time, value: avgL===0?100:100-(100/(1+(avgG/avgL))) });

  for(let i=length+1;i<points.length;i++){
    const ch = points[i].close - points[i-1].close;
    const g = Math.max(0,ch), l = Math.max(0,-ch);
    avgG = (avgG*(length-1)+g)/length;
    avgL = (avgL*(length-1)+l)/length;
    const rs = avgL===0?Infinity:avgG/avgL;
    const rsi = 100-(100/(1+rs));
    out.push({ time: points[i].time, value: rsi });
  }
  return out;
}

/* ========= Binance endpoints ========= */
const B_KLINES = (sym, intv, lim=500)=>[
  `https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${intv}&limit=${lim}`,
  `/api/binance/klines?symbol=${sym}&interval=${intv}&limit=${lim}`
];
const B_OI_PERIOD = (intv)=>({ '15m':'5m','30m':'15m','1h':'1h','2h':'1h','4h':'4h','6h':'4h','12h':'4h','1d':'1d' }[intv]||'1h');
const B_OI = (sym, intv, lim=500, custom=null)=>[
  `https://fapi.binance.com/futures/data/openInterestHist?symbol=${sym}&period=${encodeURIComponent(custom||B_OI_PERIOD(intv))}&limit=${lim}`,
  `/api/binance/openInterestHist?symbol=${sym}&period=${encodeURIComponent(custom||B_OI_PERIOD(intv))}&limit=${lim}`
];

/* ========= State ========= */
let SYMBOL = guessSymbol();
let INTERVAL = (qs.get('tf')||'1h');
let RSI_LEN = Number(localStorage.getItem('rsiLen') || 14);
let OI_PERIOD = localStorage.getItem('oiPeriod') || null;
let LAST_CANDLES = [];

/* ========= UI wires ========= */
const symEl = document.getElementById('sym');
const goBtn = document.getElementById('goBtn');
const rsiEl = document.getElementById('rsiLen');
const oiEl  = document.getElementById('oiPeriod');
symEl.value = SYMBOL; rsiEl.value = RSI_LEN; oiEl.value = OI_PERIOD || B_OI_PERIOD(INTERVAL);
document.querySelectorAll('.btn.tf').forEach(b=>{
  b.classList.toggle('on', b.dataset.i===INTERVAL);
  b.onclick = ()=>{
    document.querySelectorAll('.btn.tf').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');
    INTERVAL = b.dataset.i;
    if(!OI_PERIOD){ oiEl.value = B_OI_PERIOD(INTERVAL); }
    loadAll(SYMBOL, INTERVAL);
  };
});
goBtn.onclick = ()=>{
  SYMBOL = (symEl.value||'').toUpperCase().replace(/[^A-Z0-9]/g,'') || 'BTCUSDT';
  loadAll(SYMBOL, INTERVAL);
};
rsiEl.addEventListener('change', ()=>{
  RSI_LEN = clamp(Number(rsiEl.value||14),2,100);
  localStorage.setItem('rsiLen', String(RSI_LEN));
  if(LAST_CANDLES.length) rsiSeries.setData(calcRSI(LAST_CANDLES, RSI_LEN));
});
oiEl.addEventListener('change', async ()=>{
  OI_PERIOD = oiEl.value || null;
  localStorage.setItem('oiPeriod', OI_PERIOD||'');
  try{
    const oi = await loadOI(SYMBOL, INTERVAL);
    oiSeries.setData(oi);
  }catch{ oiSeries.setData([]); }
});
document.getElementById('fitBtn').onclick = () => main.timeScale().fitContent();
document.getElementById('resetBtn').onclick = () => {
  main.applyOptions({ timeScale:{ barSpacing:7 }});
  main.timeScale().fitContent();
};

/* ========= Chart ========= */
const main = LightweightCharts.createChart(document.getElementById('chart'),{
  layout:{ background:{type:LightweightCharts.ColorType.Solid, color:'rgba(0,0,0,0)'}, textColor:'#cfe3ff' },
  rightPriceScale:{ borderColor:'rgba(255,255,255,.10)' },
  grid:{ horzLines:{ color:'rgba(255,255,255,.04)' }, vertLines:{ color:'rgba(255,255,255,.04)' } },
  crosshair:{ mode:LightweightCharts.CrosshairMode.Normal },
  handleScroll:{ mouseWheel:true, pressedMouseMove:true, horzTouchDrag:true, vertTouchDrag:true },
  handleScale: { mouseWheel:true, pinch:true, axisPressedMouseMove:true },
  timeScale:{ borderColor:'rgba(255,255,255,.08)', barSpacing:7 }
});
const candleSeries = main.addCandlestickSeries({ priceScaleId:'main', upColor:'#22c55e', downColor:'#ef4444', borderVisible:false, wickUpColor:'#22c55e', wickDownColor:'#ef4444' });
main.priceScale('main').applyOptions({ scaleMargins:{ top:0.05, bottom:0.45 } });

const volSeries = main.addHistogramSeries({
  priceScaleId:'volume',
  priceFormat:{ type:'volume' },
  base:0, priceLineVisible:false, lastValueVisible:false
});
main.priceScale('volume').applyOptions({ scaleMargins:{ top:0.85, bottom:0.02 } });

const rsiSeries = main.addLineSeries({
  priceScaleId:'rsi', color:'#7ee7ff', lineWidth:2, priceLineVisible:false, lastValueVisible:false
});
main.priceScale('rsi').applyOptions({ scaleMargins:{ top:0.60, bottom:0.33 } });

// RSI Í∞ÄÏù¥ÎìúÎùºÏù∏(30/70)
rsiSeries.createPriceLine({ price:70, color:'rgba(255,255,255,.25)', lineStyle:LightweightCharts.LineStyle.Dotted, axisLabelVisible:false });
rsiSeries.createPriceLine({ price:30, color:'rgba(255,255,255,.25)', lineStyle:LightweightCharts.LineStyle.Dotted, axisLabelVisible:false });

const oiSeries = main.addAreaSeries({
  priceScaleId:'oi', topColor:'rgba(124,108,255,.25)', bottomColor:'rgba(124,108,255,.05)', lineColor:'rgba(124,108,255,.9)', lineWidth:2,
  priceLineVisible:false, lastValueVisible:false
});
main.priceScale('oi').applyOptions({ scaleMargins:{ top:0.70, bottom:0.18 } });

const legend = document.getElementById('legend');
function setLegend(texts){ legend.innerHTML = texts.map(t=>`<span class="tag">${t}</span>`).join(''); }

/* ========= Loaders ========= */
async function loadKlines(sym, interval){
  const [p,f] = B_KLINES(sym, interval, 800);
  const raw = await fetchJSON(p,f);
  const candles = raw.map(k=>({
    time: toSec(k[0]),
    open: Number(k[1]), high: Number(k[2]),
    low: Number(k[3]),  close: Number(k[4]),
  }));
  const vols = raw.map(k=>{
    const time = toSec(k[0]), open=Number(k[1]), close=Number(k[4]);
    return { time, value:Number(k[5]), color: close>=open ? 'rgba(34,197,94,.40)' : 'rgba(239,68,68,.40)' };
  });
  return { candles, vols };
}
async function loadOI(sym, interval){
  const [p,f] = B_OI(sym, interval, 500, OI_PERIOD);
  const raw = await fetchJSON(p,f);
  return raw.map(o=>({ time: toSec(Number(o.timestamp)), value:Number(o.sumOpenInterest) }));
}
async function loadAll(sym, interval){
  setLegend([`${sym}`, `${interval.toUpperCase()}`, `RSI:${RSI_LEN}`, `OI:${OI_PERIOD||B_OI_PERIOD(interval)}`]);
  candleSeries.setData([]); volSeries.setData([]); rsiSeries.setData([]); oiSeries.setData([]);
  try{
    const [kl, oi] = await Promise.all([ loadKlines(sym, interval), loadOI(sym, interval).catch(()=>[]) ]);
    LAST_CANDLES = kl.candles;
    candleSeries.setData(LAST_CANDLES);
    volSeries.setData(kl.vols);
    rsiSeries.setData(calcRSI(LAST_CANDLES, RSI_LEN));
    if(oi && oi.length) oiSeries.setData(oi);
    main.timeScale().fitContent();
  }catch(e){
    console.error(e);
    alert('Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.');
  }
}

/* ========= boot ========= */
loadAll(SYMBOL, INTERVAL);
window.addEventListener('resize', ()=> main.timeScale().fitContent());
</script>
</body>
</html>
