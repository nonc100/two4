<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TWO4 COSMOS</title>
  <style>
    :root{
      --bg:#0b1018; --panel:#111827; --text:#e8eefc; --muted:#9aa3b6;
      --up:#22c55e; --down:#ef4444;
      --card-border: rgba(255,255,255,.08);

      /* ÌÖåÏù¥Î∏î Ìó§Îçî sticky Í∏∞Ï§Ä(ÏÉÅÎã® Ïª®Ìä∏Î°§ ÎÜíÏù¥ + Ïó¨Î∞±) */
      --toolbar-h: 30px;

      /* ‚≠ê Î≥Ñ Î∞ùÍ∏∞/Î∞ÄÎèÑ (0~1) - Ïä¨ÎùºÏù¥ÎçîÍ∞Ä Î∞îÍøîÏ§å */
      --starVis: .35;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      background:radial-gradient(1200px 600px at 50% 0%, #182036 0%, var(--bg) 60%);
      color:var(--text);
      font:14px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic","Helvetica Neue",Arial,"Segoe UI Emoji";
      overflow-x:hidden;
    }

    /* ===== Î≥Ñ Î∞∞Í≤Ω (CSS Ìå®Îü¥Îü≠Ïä§ 3Ï∏µ) ===== */
    .sky{position:fixed; inset:0; pointer-events:none; z-index:0;}
    .stars,.stars2,.stars3{
      position:absolute; inset:0; background-repeat:repeat; background-size:1600px 1600px;
      animation:twinkle 18s linear infinite; filter:blur(.2px)
    }
    .stars{opacity:calc(.55 * var(--starVis));
      background-image:
        radial-gradient(1px 1px at 20px 30px,#fff8 50%,transparent 51%),
        radial-gradient(1px 1px at 120px 80px,#fff8 50%,transparent 51%),
        radial-gradient(1px 1px at 300px 120px,#fff8 50%,transparent 51%)}
    .stars2{opacity:calc(.35 * var(--starVis)); animation-duration:26s;
      background-image:
        radial-gradient(1px 1px at 40px 60px,#fff6 50%,transparent 51%),
        radial-gradient(1px 1px at 220px 140px,#fff6 50%,transparent 51%),
        radial-gradient(1px 1px at 460px 240px,#fff6 50%,transparent 51%)}
    .stars3{opacity:calc(.25 * var(--starVis)); animation-duration:34s;
      background-image:
        radial-gradient(1px 1px at 70px 20px,#fff5 50%,transparent 51%),
        radial-gradient(1px 1px at 260px 220px,#fff5 50%,transparent 51%),
        radial-gradient(1px 1px at 520px 420px,#fff5 50%,transparent 51%)}
    @keyframes twinkle{from{background-position:0 0} to{background-position:-1600px -1600px}}

    .wrap{position:relative; z-index:1; max-width:1220px; margin:0 auto; padding:0 16px 80px;}
    .brand{display:flex; align-items:center; gap:14px; margin:8px 0 6px;}
    .brand img{width:168px; height:auto; object-fit:contain;}
    .brand h1{margin:0; font-size:clamp(22px, 7vw, 40px); letter-spacing:.12em; font-weight:800; color:#dfe8ff; text-shadow:0 4px 24px rgba(114,157,255,.22);}
    @media (max-width:767px){.brand img{width:128px}.brand h1{letter-spacing:.08em}}

    /* ===== Ï¥àÏÜåÌòï Î≥Ñ Ïª®Ìä∏Î°§Îü¨ (ÏïÑÏù¥ÏΩò ÏÇ≠Ï†ú, ÎØ∏Îãà) ===== */
    .star-ctl{
      position:fixed; top:8px; left:50%; transform:translateX(-50%);
      z-index:20; height:24px; display:flex; align-items:center;
      padding:2px 6px; border-radius:999px;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
    }
    .star-ctl input[type="range"]{
      -webkit-appearance:none; appearance:none;
      width:140px; height:4px; background:transparent; outline:none;
    }
    .star-ctl input[type="range"]::-webkit-slider-runnable-track{
      height:4px; border-radius:999px; background:linear-gradient(90deg,#7dd3fc,#c084fc)
    }
    .star-ctl input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; width:10px;height:10px;border-radius:50%;background:#fff;
      box-shadow:0 0 10px rgba(160,220,255,.8)
    }
    .star-ctl input[type="range"]::-moz-range-track{height:4px;border-radius:999px;background:linear-gradient(90deg,#7dd3fc,#c084fc)}
    .star-ctl input[type="range"]::-moz-range-thumb{width:10px;height:10px;border:none;border-radius:50%;background:#fff;box-shadow:0 0 10px rgba(160,220,255,.8)}

    /* ===== Î¶¨Ïä§Ìä∏/ÌÖåÏù¥Î∏î ===== */
    .list{display:flex; flex-direction:column; gap:6px; margin-top:6px}
    .list .row{display:grid; grid-template-columns:2.2em 1fr auto auto; align-items:center; gap:6px; font-size:13.5px}
    .list .rank{text-align:right; opacity:.7; font-weight:700}
    .list .sym{font-weight:800; letter-spacing:.02em; color:#fff}
    .list .price{justify-self:end; opacity:.9; font-variant-numeric:tabular-nums}
    .list .pct{justify-self:end; font-weight:800; font-variant-numeric:tabular-nums}

    .controls{display:flex; gap:10px; align-items:center; margin:18px 0 10px;}
    .controls .search{flex:1}
    input[type="text"], select, button{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:var(--text); border-radius:10px; padding:9px 12px; outline:none}
    button.sortdir{min-width:40px}
    .table-wrap{overflow-x:auto}

    table{width:1200px; border-collapse:separate; border-spacing:0 10px;}
    thead th{
      position:sticky;
      top: calc(env(safe-area-inset-top,0px) + var(--toolbar-h));  /* üîß ÏÉÅÎã® Ïª®Ìä∏Î°§ ÌîºÌï¥ÏÑú Í≥†Ï†ï */
      z-index:15;
      background:rgba(17,24,39,.88); font-size:12px; color:var(--muted); font-weight:700;
      text-align:left; padding:0 10px; backdrop-filter:blur(6px)
    }
    tbody td{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); padding:12px 10px; vertical-align:middle}
    tbody tr td:first-child{border-radius:12px 0 0 12px}
    tbody tr td:last-child{border-radius:0 12px 12px 0}
    .row-index{width:46px; text-align:right; opacity:.7; font-weight:700; position:sticky; left:0; background:rgba(17,24,39,.85); backdrop-filter:blur(6px); z-index:1}
    .coin-cell{display:flex; align-items:center; gap:10px; min-width:220px; position:sticky; left:46px; background:rgba(17,24,39,.85); backdrop-filter:blur(6px); z-index:1}
    .coin-img{width:22px; height:22px; min-width:22px; border-radius:50%; object-fit:contain}
    .coin-name{font-weight:800}
    .coin-sym{opacity:.85; margin-left:4px}
    .text-right{text-align:right}

    @media (max-width:1199px){table{width:1100px}}
    @media (max-width:767px){
      .cosmos-table{table-layout:fixed !important; width:1100px}
      .row-index{width:2.2ch; padding:6px 3px; text-align:center}
      .coin-cell{left:2.2ch; min-width:9.5ch; gap:6px}
      .coin-img{width:16px;height:16px;min-width:16px}
      .coin-sym{display:none}
      /* Ïª¨Îüº Ï∂ïÏÜå/Ïà®ÍπÄ */
      .cosmos-table th:nth-child(4),.cosmos-table td:nth-child(4),
      .cosmos-table th:nth-child(6),.cosmos-table td:nth-child(6),
      .cosmos-table th:nth-child(7),.cosmos-table td:nth-child(7),
      .cosmos-table th:nth-child(8),.cosmos-table td:nth-child(8){display:none!important}
    }

    footer{margin:28px auto 0; max-width:1220px; color:#9aa3b6; opacity:.8; font-size:12px; text-align:center}

    /* ===== 3D HUB ===== */
    .hub-wrap{display:grid;grid-template-columns:minmax(320px,520px) 1fr;gap:16px;align-items:center;margin:10px 0 18px}
    .hub3d{
      position:relative;width:100%;max-width:520px;border-radius:50%;aspect-ratio:1/1;
      background:
        radial-gradient(120% 120% at 30% 30%, rgba(120,144,255,.28) 0%, rgba(80,42,150,.20) 35%, rgba(10,16,26,0) 62%),
        radial-gradient(60% 60% at 70% 70%, rgba(0,0,0,.35), rgba(0,0,0,0));
      box-shadow:
        inset 0 10px 26px rgba(180,200,255,.20),
        inset 0 -16px 46px rgba(0,0,0,.50),
        0 18px 48px rgba(0,0,0,.38),
        0 0 40px rgba(56,189,248,.20), 0 0 80px rgba(124,58,237,.16);
      backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.10); z-index:2
    }
    @supports not (aspect-ratio:1/1){.hub3d::before{content:"";display:block;padding-top:100%}.hub3d>*{position:absolute;inset:0}}
    .hub3d svg{position:absolute;inset:0}

    .hub-center{
      position:absolute; inset:50% auto auto 50%; transform:translate(-50%,-50%);
      width:36%; height:36%; border-radius:50%;
      display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
      background:radial-gradient(100% 100% at 35% 30%, rgba(34,211,238,.18), rgba(99,102,241,.12) 60%, rgba(0,0,0,0) 80%);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 6px 26px rgba(255,255,255,.10), 0 0 50px rgba(124,58,237,.22), 0 0 80px rgba(56,189,248,.18)
    }
    .hub-center .val{font-size:clamp(22px,3.6vw,32px);font-weight:900;letter-spacing:.02em;margin:0;line-height:1.1}
    .hub-center .lbl{font-size:12px;color:#9aa3b6;letter-spacing:.06em;margin:4px 0 0;line-height:1.1}

    .hub-seg{
      cursor:pointer; filter:drop-shadow(0 0 0 rgba(124,58,237,0));
      transition:transform .18s ease, filter .18s ease, opacity .18s ease, stroke .18s ease;
      transform-box: fill-box; transform-origin: center;
      stroke: rgba(255,255,255,.12); stroke-width:1.2;
    }
    .hub-seg:hover{transform:scale(1.025); filter:drop-shadow(0 0 12px rgba(124,58,237,.65)) drop-shadow(0 0 26px rgba(56,189,248,.45)); stroke: rgba(255,255,255,.25)}
    .hub-seg.active{transform:scale(1.03); filter:drop-shadow(0 0 16px rgba(124,58,237,.85)) drop-shadow(0 0 36px rgba(56,189,248,.60)); stroke: rgba(255,255,255,.35)}

    /* ‚¨Ü ÌÖçÏä§Ìä∏ Îçî ÌÅº + Í∑∏ÎùºÎç∞Ïù¥ÏÖò + Í∏ÄÎ°úÏö∞ */
    .hub-badge{
      font-weight:900;
      font-size:clamp(16px,2.2vw,22px);
      letter-spacing:.02em;
      fill:url(#mintWhiteGrad);
      filter:url(#textGlow);
      pointer-events:none;
    }

    .hub-panel{position:relative; min-height:260px; border-radius:16px; padding:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10); box-shadow:0 10px 30px rgba(0,0,0,.30); backdrop-filter:blur(14px)}
    .hub-panel.hidden{display:none}
    .hub-panel h4{margin:2px 0 10px; font-size:14px; color:#9aa3b6; letter-spacing:.08em}
    .hub-list{display:flex; flex-direction:column; gap:6px}
    .hub-row{display:grid; grid-template-columns:1.6em 1fr auto auto; gap:8px; align-items:center; font-size:13.5px}
    .hub-row .rk{opacity:.7;text-align:right;font-weight:800}
    .hub-row .tk{font-weight:900;color:#fff}
    .hub-row .px{opacity:.9;text-align:right}
    .hub-row .pc{font-weight:900;text-align:right}
    .hub-row .pc.up{color:#22c55e}.hub-row .pc.down{color:#ef4444}

    @media (max-width:767px){.hub-wrap{grid-template-columns:1fr}.hub3d{max-width:360px;margin:0 auto}}

    /* Í∏∞Ï°¥ Ïπ¥Îìú ÏÑπÏÖò Í∞êÏ∂§(ÌóàÎ∏å UIÎßå ÏÇ¨Ïö©) */
    .cards{display:none!important}
  </style>
</head>
<body>
  <!-- ‚≠ê Î≥Ñ Î∞∞Í≤Ω -->
  <div class="sky"><div class="stars"></div><div class="stars2"></div><div class="stars3"></div></div>

  <!-- ‚≠ê Ï¥àÏÜåÌòï ÏÉÅÎã® Ïª®Ìä∏Î°§Îü¨ (ÏïÑÏù¥ÏΩò Ï†úÍ±∞) -->
  <div class="star-ctl" aria-label="Star background controller">
    <input id="starRange" type="range" min="0" max="100" />
  </div>

  <div class="wrap">
    <div class="brand">
      <img src="/media/logo.png" alt="TWO4">
      <h1>COSMOS</h1>
    </div>

    <!-- ===== 3D Hub ===== -->
    <section class="hub-wrap">
      <div class="hub3d">
        <svg id="hubSvg" viewBox="0 0 1000 1000" role="img" aria-label="Cosmos overview hub">
          <!-- ÌÖçÏä§Ìä∏ Í∑∏ÎùºÎç∞Ïù¥ÏÖò/Í∏ÄÎ°úÏö∞ Ï†ïÏùò -->
          <defs>
            <linearGradient id="mintWhiteGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#dffff9"/>
              <stop offset="100%" stop-color="#7efcf3"/>
            </linearGradient>
            <filter id="textGlow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="2.2" result="blur"/>
              <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
          </defs>
        </svg>
        <div class="hub-center">
          <div class="val" id="hubVal">‚Äî</div>
          <div class="lbl" id="hubLbl">COSMOS</div>
        </div>
      </div>
      <aside class="hub-panel hidden" id="hubPanel">
        <h4 id="hubTitle">‚Äî</h4>
        <div id="hubContent"></div>
      </aside>
    </section>

    <!-- ===== Controls ===== -->
    <div class="controls">
      <input class="search" type="text" id="search" placeholder="ÏΩîÏù∏ Í≤ÄÏÉâ (Ïù¥Î¶Ñ/Ïã¨Î≥º)">
      <label>Ï†ïÎ†¨:
        <select id="sortkey">
          <option value="market_cap">ÏãúÍ∞ÄÏ¥ùÏï°</option>
          <option value="price">Í∞ÄÍ≤©</option>
          <option value="volume">Í±∞ÎûòÎüâ</option>
          <option value="change1h">1ÏãúÍ∞Ñ</option>
          <option value="change24h">24ÏãúÍ∞Ñ</option>
          <option value="change7d">7Ïùº</option>
          <option value="rank">ÏàúÏúÑ</option>
        </select>
      </label>
      <button id="sortdir" class="sortdir" title="Ï†ïÎ†¨ Î∞©Ìñ•">‚ñº</button>
      <label>ÌéòÏù¥ÏßÄ:
        <select id="page"></select>
      </label>
    </div>

    <!-- ===== Table ===== -->
    <div class="table-wrap">
      <table class="cosmos-table">
        <colgroup>
          <col class="col-rank"><col class="col-coin"><col class="col-price">
          <col class="col-ch1h"><col class="col-ch24"><col class="col-ch7d">
          <col class="col-mcap"><col class="col-vol"><col class="col-spark">
        </colgroup>
        <thead>
          <tr>
            <th class="text-right">ÏàúÏúÑ</th>
            <th>ÏΩîÏù∏</th>
            <th class="text-right">ÏãúÏÑ∏</th>
            <th class="text-right">1ÏãúÍ∞Ñ</th>
            <th class="text-right">24ÏãúÍ∞Ñ</th>
            <th class="text-right">7Ïùº</th>
            <th class="text-right">ÏãúÍ∞ÄÏ¥ùÏï°</th>
            <th class="text-right">Í±∞ÎûòÎüâ</th>
            <th class="text-right">7Ïùº Ï∞®Ìä∏</th>
          </tr>
        </thead>
        <tbody id="cosmos-tbody"></tbody>
      </table>
    </div>

    <footer>
      üöÄ Cosmos ÏïîÌò∏ÌôîÌèê ÎåÄÏãúÎ≥¥Îìú ‚Äì CoinGecko API, Alternative.me, Binance Îç∞Ïù¥ÌÑ∞ | 3D ÎÑ§Ïò® ÌóàÎ∏å Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ | Î∞±ÏóîÎìú ÌîÑÎ°ùÏãú ÏßÄÏõê | 30Ï¥à ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏
    </footer>
  </div>

  <!-- Í≥µÏö© Ïä§ÌÅ¨Î¶ΩÌä∏ -->
  <script src="./cosmos.js"></script>

  <!-- ‚úÖ cosmos.js Ìï´ÌîΩÏä§(ÎèôÏùº): ÏùºÎ∂Ä API Ïã§Ìå®Ìï¥ÎèÑ Ìëú/ÌóàÎ∏åÎäî Í∑∏Î¶¥ Ïàò ÏûàÍ≤å -->
  <script>
  (function(){
    function patch(){
      if (window.fetchMarketChart) window.fetchMarketChart = async ()=>null;
      if (window._cosmos && typeof window._cosmos.initData === 'function') {
        const st = window._cosmos.state;
        window._cosmos.initData = async function(){
          try{
            const rs = await Promise.allSettled([
              fetchMarkets(), fetchGlobal(), fetchFNG(), fetchBinanceLS(st.lsPeriod)
            ]);
            const markets = rs[0].status==='fulfilled' ? rs[0].value : [];
            const global  = rs[1].status==='fulfilled' ? rs[1].value : null;
            const fng     = rs[2].status==='fulfilled' ? rs[2].value : null;
            const ls      = rs[3].status==='fulfilled' ? rs[3].value : null;

            st.all = Array.isArray(markets)? markets : [];
            renderKPIs(st.all, global);
            renderRightLists(st.all);
            applySortFilter();
            if (fng) renderFNGCard(fng);
            if (ls)  renderLongShort(st.lsPeriod, ls);
          }catch(e){ console.error(e); applySortFilter(); }
        };
        window._cosmos.initData();
      }
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', patch);
    else patch();
  })();
  </script>

  <!-- ‚≠ê Ïª®Ìä∏Î°§Îü¨ ÎèôÏûë(Í∞í Ï†ÄÏû•/Î≥µÏõê Ìè¨Ìï®) -->
  <script>
    (function(){
      const range = document.getElementById('starRange');
      const KEY = 'two4_star';
      const saved = Math.max(0, Math.min(100, Number(localStorage.getItem(KEY) ?? 35)));
      range.value = String(saved);
      apply(saved);

      range.addEventListener('input', e=>{
        const v = Math.max(0, Math.min(100, Number(e.target.value||0)));
        apply(v);
        localStorage.setItem(KEY, String(v));
      });

      function apply(v){
        document.documentElement.style.setProperty('--starVis', String(v/100));
      }
    })();
  </script>

  <!-- ===== 3D HUB Ïä§ÌÅ¨Î¶ΩÌä∏(ÎùºÎ≤® Ï†ïÎ¶¨/ÌÖçÏä§Ìä∏ ÌôïÎåÄ Î∞òÏòÅ) ===== -->
  <script>
  (function(){
    const TAU = Math.PI*2;
    const svg = document.getElementById('hubSvg');
    const centerVal = document.getElementById('hubVal');
    const centerLbl = document.getElementById('hubLbl');
    const panel = document.getElementById('hubPanel');
    const panelTitle = document.getElementById('hubTitle');
    const panelContent = document.getElementById('hubContent');

    function arcPath(cx, cy, r0, r1, a0, a1){
      const p=(r,a)=>[cx+r*Math.cos(a),cy+r*Math.sin(a)];
      const [x0,y0]=p(r1,a0),[x1,y1]=p(r1,a1),[x2,y2]=p(r0,a1),[x3,y3]=p(r0,a0);
      const laf=(a1-a0)>Math.PI?1:0;
      return `M ${x0} ${y0} A ${r1} ${r1} 0 ${laf} 1 ${x1} ${y1} L ${x2} ${y2} A ${r0} ${r0} 0 ${laf} 0 ${x3} ${y3} Z`;
    }
    function fmtPct(n){if(n==null||isNaN(n))return'-';const s=n>=0?'+':'';return s+n.toFixed(2)+'%'}
    function fmtNum(n){if(n==null||isNaN(n))return'-';const a=Math.abs(n);if(a>=1e12)return'$'+(n/1e12).toFixed(2)+'T';if(a>=1e9)return'$'+(n/1e9).toFixed(2)+'B';if(a>=1e6)return'$'+(n/1e6).toFixed(2)+'M';return '$'+Number(n).toLocaleString('en-US',{maximumFractionDigits:2})}
    function setCenter(lbl,val){centerLbl.textContent=lbl;centerVal.textContent=val}
    function openPanel(s){panel.classList.remove('hidden');panelTitle.textContent=s.title;panelContent.innerHTML=s.html}

    function ensureDefs(){let defs = svg.querySelector('defs'); if(!defs){ defs = document.createElementNS(svg.namespaceURI,'defs'); svg.appendChild(defs); } return defs;}

    function buildHub(sections){
      svg.innerHTML = svg.innerHTML; // defs Ïú†ÏßÄ
      const cx=500,cy=500,rO=470,rI=260,seg=TAU/sections.length, start=-Math.PI/2;
      const defs = ensureDefs();
      sections.forEach((s,i)=>{
        const gid=`g${i}`;
        const grad=document.createElementNS(svg.namespaceURI,'linearGradient');
        grad.id=gid; grad.setAttribute('x1','0');grad.setAttribute('y1','0');grad.setAttribute('x2','1');grad.setAttribute('y2','1');
        const st1=document.createElementNS(grad.namespaceURI,'stop');st1.setAttribute('offset','0%');st1.setAttribute('stop-color','#7c3aed');st1.setAttribute('stop-opacity','.58');
        const st2=document.createElementNS(grad.namespaceURI,'stop');st2.setAttribute('offset','100%');st2.setAttribute('stop-color','#06b6d4');st2.setAttribute('stop-opacity','.46');
        grad.appendChild(st1);grad.appendChild(st2); defs.appendChild(grad);

        const a0=start+seg*i+0.014, a1=start+seg*(i+1)-0.014;
        const path=document.createElementNS(svg.namespaceURI,'path');
        path.setAttribute('d',arcPath(cx,cy,rI,rO,a0,a1));
        path.setAttribute('fill',`url(#${gid})`);
        path.setAttribute('opacity','.92');
        path.classList.add('hub-seg');
        svg.appendChild(path);

        /* ‚¨Ü ÌÅ∞ Î†àÏù¥Î∏î */
        const mid=(a0+a1)/2, rx=(rI+rO)/2, tx=cx+(rx-30)*Math.cos(mid), ty=cy+(rx-30)*Math.sin(mid)+6;
        const text=document.createElementNS(svg.namespaceURI,'text');
        text.setAttribute('x',tx); text.setAttribute('y',ty);
        text.setAttribute('text-anchor','middle');
        text.classList.add('hub-badge');
        text.textContent=s.badge;
        svg.appendChild(text);

        function act(){
          svg.querySelectorAll('.hub-seg').forEach(el=>el.classList.remove('active'));
          path.classList.add('active'); setCenter(s.centerLbl,s.centerVal); openPanel(s);
        }
        path.addEventListener('mouseenter',()=>setCenter(s.centerLbl,s.centerVal));
        path.addEventListener('click',act);
        text.addEventListener('click',act);
      });
    }

    async function gather(){
      const results=await Promise.allSettled([
        fetchMarkets(), fetchGlobal(), fetchFNG(),
        fetchBinanceLS('1h'), fetchBinanceLS('4h'), fetchBinanceLS('1d')
      ]);
      const get=(i,d=null)=>results[i].status==='fulfilled'?results[i].value:d;
      const markets=Array.isArray(get(0,[]))?get(0,[]):[], global=get(1,null), fng=get(2,null);
      const byId=Object.fromEntries(markets.map(m=>[m.id,m])); const btc=byId.bitcoin||null, usdt=byId.tether||null;
      const gainers=markets.filter(x=>Number.isFinite(x.price_change_percentage_24h)).sort((a,b)=>b.price_change_percentage_24h-a.price_change_percentage_24h).slice(0,10);
      const byVol=markets.slice().sort((a,b)=>b.total_volume-a.total_volume).slice(0,10);
      function parseLS(arr){const last=Array.isArray(arr)&&arr.length?arr[arr.length-1]:null; const ratio=last?Number(last.longShortRatio||0):0; const sp=ratio?100/(1+ratio):50; return {ratio,longPct:100-sp,shortPct:sp}}
      const ls={h1:parseLS(get(3,null)),h4:parseLS(get(4,null)),d1:parseLS(get(5,null))};
      return {markets,btc,usdt,gainers,byVol,dominance:(global?.data?.market_cap_percentage?.btc??0),fng:Array.isArray(fng?.data)?fng.data[0]:null,ls};
    }

    function listHTML(items,kind){
      return `<div class="hub-list">`+items.map((c,i)=>{
        const tk=(c.symbol||'').toUpperCase(), px=fmtNum(c.current_price);
        const pc=kind==='vol'?fmtNum(c.total_volume):fmtPct(c.price_change_percentage_24h);
        const cls=kind==='vol'?'':((c.price_change_percentage_24h||0)>=0?'up':'down');
        return `<div class="hub-row"><div class="rk">${i+1}</div><div class="tk">${tk}</div><div class="px">${px}</div><div class="pc ${cls}">${pc}</div></div>`;
      }).join('')+`</div>`;
    }

    async function initHub(){
      try{
        const d=await gather(); const fngLbl=d.fng?`${d.fng.value} / ${d.fng.value_classification||'‚Äî'}`:'‚Äî';
        const secs=[
          {
            badge:`${d.ls.h1.longPct.toFixed(0)}%`,
            centerLbl:'Î°±/Ïàè (1H)',
            centerVal:`${d.ls.h1.longPct.toFixed(1)} / ${d.ls.h1.shortPct.toFixed(1)}%`,
            title:'Long / Short (1H)',
            html:`<div>BTCUSDT Ìè¨ÏßÄÏÖò ÎπÑÏú®</div>
                  <div style="margin-top:8px;height:8px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden">
                    <div style="width:${d.ls.h1.longPct.toFixed(1)}%;height:100%;background:#22c55e"></div>
                  </div>
                  <div style="margin-top:6px;display:flex;justify-content:space-between">
                    <div>Long ${d.ls.h1.longPct.toFixed(1)}%</div>
                    <div>Short ${d.ls.h1.shortPct.toFixed(1)}% ¬∑ ratio ${d.ls.h1.ratio.toFixed(2)}</div>
                  </div>`
          },
          {
            badge:`${(d.dominance||0).toFixed(0)}%`,
            centerLbl:'BTC ÎèÑÎØ∏ÎÑåÏä§',
            centerVal:`${(d.dominance||0).toFixed(2)}%`,
            title:'BTC Dominance',
            html:`<div>ÌòÑÏû¨ ${(d.dominance||0).toFixed(2)}%</div>`
          },
          {
            badge:d.fng?`${d.fng.value}`:'‚Äî',
            centerLbl:'Í≥µÌè¨/ÌÉêÏöï',
            centerVal:fngLbl,
            title:'Fear & Greed Index',
            html:`<div>${fngLbl}</div>`
          },
          {
            badge:d.btc?fmtNum(d.btc.market_cap):'‚Äî',
            centerLbl:'BTC ÏãúÏ¥ù',
            centerVal:d.btc?fmtNum(d.btc.market_cap):'‚Äî',
            title:'BTC Market Cap',
            html:`<div>${d.btc?fmtNum(d.btc.market_cap):'‚Äî'}</div>`
          },
          {
            badge:d.usdt?fmtNum(d.usdt.market_cap):'‚Äî',
            centerLbl:'USDT ÏãúÏ¥ù',
            centerVal:d.usdt?fmtNum(d.usdt.market_cap):'‚Äî',
            title:'USDT Market Cap',
            html:`<div>${d.usdt?fmtNum(d.usdt.market_cap):'‚Äî'}</div>`
          },
          {
            badge:'TOP10',
            centerLbl:'24H Gainers',
            centerVal:'(USDT)',
            title:'24H Gainers (USDT)',
            html: listHTML(d.gainers,'pct')
          },
          {
            badge:'VOL',
            centerLbl:'Volume Top 10',
            centerVal:'',
            title:'Volume Top 10',
            html: listHTML(d.byVol,'vol')
          }
        ];
        buildHub(secs); setCenter('COSMOS','‚Äî');
      }catch(e){
        console.error(e);
        buildHub([{badge:'‚Äî',centerLbl:'COSMOS',centerVal:'‚Äî',title:'COSMOS',html:'<div>Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.</div>'}]);
        setCenter('COSMOS','‚Äî');
      }
    }

    initHub();
    setInterval(initHub,60*1000);
  })();
  </script>
</body>
</html>
