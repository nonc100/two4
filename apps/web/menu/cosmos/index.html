<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>TWO4 COSMOS</title>
<style>
:root{
  --bg:#0b1018; --panel:#111827; --text:#e8eefc; --muted:#9aa3b6;
  --up:#22c55e; --down:#ef4444;
  --starVis:.7; /* 0~1 */
  --stickyTop: 48px; /* 헤더 고정 간격(별 컨트롤러 높이) */
}

/* reset + links */
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:radial-gradient(1200px 600px at 50% 0%, #182036 0%, var(--bg) 60%);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic"}
a,a:link,a:visited,a:active{color:inherit;text-decoration:none} a:hover{opacity:.9}

/* star sky */
.sky{position:fixed; inset:0; pointer-events:none; z-index:0}
.stars,.stars2,.stars3{position:absolute; inset:0; background-repeat:repeat; background-size:1600px 1600px; animation:twinkle 22s linear infinite; filter:blur(.2px)}
.stars{opacity:calc(.55*var(--starVis));background-image:
  radial-gradient(1px 1px at 20px 30px,#fff8 50%,transparent 51%),
  radial-gradient(1px 1px at 120px 80px,#fff8 50%,transparent 51%),
  radial-gradient(1px 1px at 300px 120px,#fff8 50%,transparent 51%)}
.stars2{opacity:calc(.35*var(--starVis));animation-duration:30s;background-image:
  radial-gradient(1px 1px at 40px 60px,#fff6 50%,transparent 51%),
  radial-gradient(1px 1px at 220px 140px,#fff6 50%,transparent 51%),
  radial-gradient(1px 1px at 460px 240px,#fff6 50%,transparent 51%)}
.stars3{opacity:calc(.25*var(--starVis));animation-duration:36s;background-image:
  radial-gradient(1px 1px at 70px 20px,#fff5 50%,transparent 51%),
  radial-gradient(1px 1px at 260px 220px,#fff5 50%,transparent 51%),
  radial-gradient(1px 1px at 520px 420px,#fff5 50%,transparent 51%)}
@keyframes twinkle{from{background-position:0 0}to{background-position:-1600px -1600px}}

.wrap{position:relative; z-index:1; max-width:1220px; margin:0 auto; padding:0 14px 80px}

/* brand */
.brand{display:flex; align-items:center; gap:12px; margin:12px 0 8px}
.brand img{height:42px; width:auto}

/* tiny star controller */
.star-ctl{position:fixed; top:6px; left:50%; transform:translateX(-50%); z-index:10; display:flex; align-items:center; gap:8px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.10); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.16)}
.star-ctl input{width:120px; height:6px; appearance:none; background:linear-gradient(90deg,#a78bfa,#22d3ee); border-radius:6px; outline:none}
.star-ctl input::-webkit-slider-thumb{appearance:none;width:12px;height:12px;border-radius:50%;background:#fff;border:1px solid #a78bfa}

/* hub */
.hub-wrap{display:grid;grid-template-columns:minmax(320px,520px) 1fr;gap:16px;align-items:center}
@media(max-width:900px){.hub-wrap{grid-template-columns:1fr}}
.hub3d{position:relative; max-width:520px; aspect-ratio:1/1; border-radius:50%;
  background:radial-gradient(120% 120% at 30% 30%, rgba(120,144,255,.28) 0%, rgba(80,42,150,.20) 35%, rgba(0,0,0,0) 62%),
             radial-gradient(60% 60% at 70% 70%, rgba(0,0,0,.35), rgba(0,0,0,0));
  box-shadow:inset 0 10px 26px rgba(180,200,255,.18), inset 0 -16px 46px rgba(0,0,0,.50), 0 18px 48px rgba(0,0,0,.38), 0 0 40px rgba(56,189,248,.20), 0 0 80px rgba(124,58,237,.16);
  border:1px solid rgba(255,255,255,.08)}
.hub3d svg{position:absolute; inset:0}
.hub-center{position:absolute; inset:50% auto auto 50%; transform:translate(-50%,-50%); width:36%; height:36%; border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
  background:radial-gradient(100% 100% at 35% 30%, rgba(34,211,238,.18), rgba(99,102,241,.12) 60%, rgba(0,0,0,0) 80%); border:1px solid rgba(255,255,255,.14); box-shadow:inset 0 6px 26px rgba(255,255,255,.10), 0 0 50px rgba(124,58,237,.22), 0 0 80px rgba(56,189,248,.18)}
.center-main{font-weight:900; font-size:clamp(20px,3.3vw,28px); line-height:1.1}
.center-sub{font-size:12px; color:#9aa3b6; margin-top:6px}

/* 섹터 라벨 크게 + 그라데이션 + 글로우 */
.hub-badge{font-weight:900; font-size:clamp(16px,2.8vw,22px); letter-spacing:.02em; fill:url(#mintWhiteGrad); filter:url(#textGlow); pointer-events:none}
.hub-seg{cursor:pointer; filter:drop-shadow(0 0 0 rgba(124,58,237,0)); transition:transform .18s ease, filter .18s ease, opacity .18s ease, stroke .18s ease; transform-box: fill-box; transform-origin: center; stroke: rgba(255,255,255,.12); stroke-width:1.2}
.hub-seg:hover{transform:scale(1.025); filter:drop-shadow(0 0 12px rgba(124,58,237,.65)) drop-shadow(0 0 26px rgba(56,189,248,.45)); stroke: rgba(255,255,255,.25)}
.hub-seg.active{transform:scale(1.03); filter:drop-shadow(0 0 16px rgba(124,58,237,.85)) drop-shadow(0 0 36px rgba(56,189,248,.60)); stroke: rgba(255,255,255,.35)}

/* panel */
.panel{min-height:260px; border-radius:16px; padding:14px; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.10); box-shadow:0 10px 30px rgba(0,0,0,.30); backdrop-filter:blur(14px)}
.panel h4{margin:2px 0 10px; font-size:14px; color:#9aa3b6; letter-spacing:.08em}
.list{display:flex; flex-direction:column; gap:6px}
.row{display:grid; grid-template-columns:1.6em 1fr auto auto; gap:8px; align-items:center; font-size:13.5px}
.row .rk{text-align:right; opacity:.7; font-weight:800}
.row .tk{font-weight:900}
.row .px{opacity:.9;text-align:right}
.row .pc{font-weight:900;text-align:right}
.row .pc.up{color:var(--up)} .row .pc.down{color:var(--down)}

/* controls (search only, 정렬 제거) */
.controls{display:flex; gap:10px; align-items:center; margin:18px 0 10px}
.controls .search{flex:1}
input[type="text"]{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:var(--text); border-radius:10px; padding:9px 12px; outline:none}

/* table */
.table-wrap{overflow-x:auto; margin-top:6px}
table{width:1200px; border-collapse:separate; border-spacing:0 10px}
thead th{position:sticky; top:var(--stickyTop); background:rgba(17,24,39,.86); font-size:12px; color:var(--muted); font-weight:800; text-align:left; padding:8px 10px; backdrop-filter:blur(6px); cursor:pointer; user-select:none}
thead th .dir{opacity:.8; margin-left:4px}
tbody td{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); padding:12px 10px; vertical-align:middle}
tbody tr td:first-child{border-radius:12px 0 0 12px}
tbody tr td:last-child{border-radius:0 12px 12px 0}
.row-index{width:38px; text-align:right; opacity:.8; font-weight:800; position:sticky; left:0; background:rgba(17,24,39,.86); backdrop-filter:blur(6px); z-index:1}
.coin-cell{display:flex; align-items:center; gap:10px; min-width:200px; position:sticky; left:38px; background:rgba(17,24,39,.86); backdrop-filter:blur(6px); z-index:1}
.coin-img{width:20px; height:20px; min-width:20px; border-radius:50%}
.text-right{text-align:right}
.pct.up{color:var(--up)} .pct.down{color:var(--down)} .pct.neutral{opacity:.8}
.spark svg{display:block}

/* pager */
.pager{display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin:10px 0}
.pager button{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer}
.pager button.on{background:#384152; border-color:#64748b}

/* mobile tweaks: 칼럼 자동폭, 스파크/변동률 유지 */
@media(max-width:767px){
  table{width:1100px; table-layout:auto}
  .row-index{width:34px; left:0}
  .coin-cell{left:34px; min-width:170px; gap:8px}
  .coin-img{width:16px;height:16px;min-width:16px}
}

/* footer */
footer{margin:28px auto 0; max-width:1220px; color:#9aa3b6; opacity:.8; font-size:12px; text-align:center}
</style>
</head>
<body>
<!-- star background -->
<div class="sky"><div class="stars"></div><div class="stars2"></div><div class="stars3"></div></div>

<!-- tiny star controller -->
<div class="star-ctl"><input id="starRange" type="range" min="0" max="100" value="70"></div>

<div class="wrap">
  <div class="brand">
    <img src="/media/logo.png" alt="TWO4">
    <!-- 요청대로 COSMOS 텍스트 제거 -->
  </div>

  <!-- HUB -->
  <section class="hub-wrap">
    <div class="hub3d">
      <svg id="hubSvg" viewBox="0 0 1000 1000" role="img" aria-label="Cosmos overview hub">
        <defs>
          <linearGradient id="mintWhiteGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#dffff9"/><stop offset="100%" stop-color="#7efcf3"/>
          </linearGradient>
          <filter id="textGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
      </svg>
      <div class="hub-center">
        <div class="center-main" id="hubMain">—</div>
        <div class="center-sub" id="hubSub">COSMOS</div>
      </div>
    </div>
    <aside class="panel" id="hubPanel">
      <h4 id="hubTitle">—</h4>
      <div id="hubContent"></div>
    </aside>
  </section>

  <!-- Controls (search only) -->
  <div class="controls">
    <input class="search" type="text" id="search" placeholder="코인 검색 (이름/심볼)">
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table id="mkt">
      <thead>
        <tr>
          <th data-key="rank">순위 <span class="dir"></span></th>
          <th data-key="symbol">코인 <span class="dir"></span></th>
          <th class="text-right" data-key="price">시세 <span class="dir"></span></th>
          <th class="text-right" data-key="change1h">1h <span class="dir"></span></th>
          <th class="text-right" data-key="change24h">24h <span class="dir"></span></th>
          <th class="text-right" data-key="change7d">7d <span class="dir"></span></th>
          <th class="text-right" data-key="market_cap">시가총액 <span class="dir"></span></th>
          <th class="text-right" data-key="volume">거래량 <span class="dir"></span></th>
          <th class="text-right">7일 차트</th>
        </tr>
      </thead>
      <tbody id="cosmos-tbody"></tbody>
    </table>
  </div>
  <div class="pager" id="pager"></div>

  <footer>🚀 CoinGecko · Binance · Alternative.me | 3D 네온 허브 · 30초 자동 업데이트</footer>
</div>

<script>
/* ===== Utils ===== */
const clamp=(n,a,b)=>Math.min(b,Math.max(a,n));
const $=(s,sc=document)=>sc.querySelector(s);
const $$=(s,sc=document)=>Array.from(sc.querySelectorAll(s));
const setHTML=(sel,html)=>{const el=typeof sel==="string"?$(sel):sel; if(el) el.innerHTML=html;};
const safeLocale=(num,minFD=0,maxFD=2)=>{let m=Number.isFinite(minFD)?clamp(minFD,0,20):0,x=Number.isFinite(maxFD)?clamp(maxFD,0,20):2; if(x<m)x=m; try{return Number(num??0).toLocaleString('en-US',{minimumFractionDigits:m,maximumFractionDigits:x});}catch{return String(Number(num??0).toFixed(x));}};
const fmtPrice=v=>v==null||Number.isNaN(v)?"-":"$"+safeLocale(v, v>=1?2: (v>0? Math.min(8, Math.ceil(Math.abs(Math.log10(v)))+2):2), v>=1?2: (v>0? Math.min(8, Math.ceil(Math.abs(Math.log10(v)))+2):2));
const fmtPctHTML=v=>{if(v==null||Number.isNaN(v))return'<span class="pct neutral">-</span>'; const n=Number(v),cls=n>0?'up':n<0?'down':'neutral',sign=n>0?'+':''; return `<span class="pct ${cls}">${sign}${n.toFixed(2)}%</span>`};
const fmtNumSuffix=v=>{if(v==null||Number.isNaN(v))return "-";const n=Number(v),a=Math.abs(n);if(a>=1e12)return"$"+(n/1e12).toFixed(2)+"T";if(a>=1e9)return"$"+(n/1e9).toFixed(2)+"B";if(a>=1e6)return"$"+(n/1e6).toFixed(2)+"M";if(a>=1e3)return"$"+(n/1e3).toFixed(2)+"K";return"$"+safeLocale(n,0,2)};
const sparkSVG=(arr,w=110,h=28)=>{if(!arr||arr.length<2)return"";const mi=Math.min(...arr),ma=Math.max(...arr),sp=(ma-mi)||1,pts=arr.map((p,i)=>{const x=(i/(arr.length-1))*w,y=h-((p-mi)/sp)*h;return `${x.toFixed(1)},${y.toFixed(1)}`}).join(" ");const up=arr.at(-1)>=arr[0];return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><polyline fill="none" stroke="${up?'#22c55e':'#ef4444'}" stroke-width="2" points="${pts}"/></svg>`};

/* ===== Data fetch (fallback to /api/* when CORS/limit) ===== */
async function xfetch(url, fallback){
  try{const r=await fetch(url); if(!r.ok) throw 0; return await r.json();}
  catch{const r2=await fetch(fallback); if(!r2.ok) throw new Error("fetch failed"); return await r2.json();}
}
async function fetchMarkets({vs="usd",perPage=200,page=1}={}){const q=`vs_currency=${vs}&order=market_cap_desc&per_page=${perPage}&page=${page}&sparkline=true&price_change_percentage=1h,24h,7d`; return xfetch(`https://api.coingecko.com/api/v3/coins/markets?${q}`, `/api/coins/markets?${q}`)}
async function fetchGlobal(){return xfetch('https://api.coingecko.com/api/v3/global','/api/global')}
async function fetchFNG(){return xfetch('https://api.alternative.me/fng/?limit=2','/api/fng')}
async function fetchBinanceLS(period='1h'){const sym='BTCUSDT',q=`symbol=${sym}&period=${period}&limit=1`;return xfetch(`https://fapi.binance.com/futures/data/globalLongShortAccountRatio?${q}`,`/api/binance/globalLongShortAccountRatio?${q}`)}
async function fetchMarketChart(id,days=7){const q=`vs_currency=usd&days=${days}`;return xfetch(`https://api.coingecko.com/api/v3/coins/${encodeURIComponent(id)}/market_chart?${q}`,`/api/coins/${encodeURIComponent(id)}/market_chart?${q}`)}

/* ===== State ===== */
const state={all:[],filtered:[],page:1,perPage:50,sortKey:"market_cap",sortDir:-1,filterQ:""};

/* ===== Table build ===== */
function rowHTML(c){
  const s7=(c.sparkline_in_7d&&c.sparkline_in_7d.price)||null, sym=(c.symbol||"").toUpperCase();
  return `<tr>
    <td class="row-index">${c.market_cap_rank ?? "-"}</td>
    <td class="coin-cell"><img class="coin-img" src="${c.image}" alt="${sym}"><span class="coin-name">${sym}</span><span class="coin-sym" style="opacity:.8;margin-left:6px">${c.name ?? ""}</span></td>
    <td class="text-right">${fmtPrice(c.current_price)}</td>
    <td class="text-right">${fmtPctHTML(c.price_change_percentage_1h_in_currency ?? c.price_change_percentage_1h ?? null)}</td>
    <td class="text-right">${fmtPctHTML(c.price_change_percentage_24h_in_currency ?? c.price_change_percentage_24h ?? null)}</td>
    <td class="text-right">${fmtPctHTML(c.price_change_percentage_7d_in_currency ?? null)}</td>
    <td class="text-right">${fmtNumSuffix(c.market_cap)}</td>
    <td class="text-right">${fmtNumSuffix(c.total_volume)}</td>
    <td class="text-right spark">${s7?sparkSVG(s7):""}</td>
  </tr>`;
}
function renderTable(){
  const tbody=$("#cosmos-tbody"); if(!tbody) return;
  const s=(state.page-1)*state.perPage,e=s+state.perPage, slice=state.filtered.slice(s,e);
  setHTML(tbody, slice.map(rowHTML).join("") || `<tr><td colspan="9" class="text-right" style="text-align:center">데이터 없음</td></tr>`);
}
function renderPager(){
  const el=$("#pager"); if(!el) return;
  const total=Math.max(1,Math.ceil(state.filtered.length/state.perPage));
  const cur=state.page;
  let html="";
  const btn=(p,lab=p,cls="")=>`<button data-p="${p}" class="${cls}">${lab}</button>`;
  html+=btn(1,"«"); html+=btn(Math.max(1,cur-1),"‹");
  const span=5, start=Math.max(1,cur-Math.floor(span/2)), end=Math.min(total,start+span-1);
  for(let i=start;i<=end;i++) html+=btn(i,i, i===cur?"on":"");
  html+=btn(Math.min(total,cur+1),"›"); html+=btn(total,"»");
  el.innerHTML=html;
  el.querySelectorAll("button").forEach(b=>b.onclick=()=>{const p=Number(b.dataset.p)||1; if(p!==state.page){state.page=p; renderTable(); renderPager();}});
}

/* search & sort */
function applyFilterSort(){
  const q=state.filterQ.toLowerCase();
  let arr=state.all.filter(c=>!q || (c.symbol||"").toLowerCase().includes(q) || (c.name||"").toLowerCase().includes(q));
  const dir=state.sortDir,k=state.sortKey,get=c=>({market_cap:c.market_cap??-1, price:c.current_price??-1, volume:c.total_volume??-1, change1h:c.price_change_percentage_1h_in_currency ?? c.price_change_percentage_1h ?? -1, change24h:c.price_change_percentage_24h_in_currency ?? c.price_change_percentage_24h ?? -1, change7d:c.price_change_percentage_7d_in_currency ?? -1, rank:c.market_cap_rank ?? 1e9, symbol:(c.symbol||"").toUpperCase()}[k]??0);
  arr.sort((a,b)=>{const va=get(a),vb=get(b); const r=(typeof va==="string"&&typeof vb==="string")?va.localeCompare(vb):(va>vb?1:va<vb?-1:0); return r*dir;});
  state.filtered=arr; if((state.page-1)*state.perPage >= arr.length) state.page=1;
  // 헤더 표시
$$("#mkt thead th[data-key]").forEach(th=>{
  const d = th.querySelector(".dir");
  if (d) d.textContent = (th.dataset.key===state.sortKey ? (state.sortDir===-1?"▼":"▲") : "");
});  renderTable(); renderPager();
}

/* header click sort */
function wireHeaderSort(){
  $$("#mkt thead th[data-key]").forEach(th=>{
    th.addEventListener("click",()=>{
      const key=th.dataset.key;
      if(state.sortKey===key) state.sortDir*=-1;
      else {state.sortKey=key; state.sortDir=-1;}
      applyFilterSort();
    });
  });
}

/* ===== HUB ===== */
(function Hub(){
  const svg=$("#hubSvg"), main=$("#hubMain"), sub=$("#hubSub"), title=$("#hubTitle"), content=$("#hubContent");
  const TAU=Math.PI*2;
  const arc=(cx,cy,r0,r1,a0,a1)=>{const p=(r,a)=>[cx+r*Math.cos(a),cy+r*Math.sin(a)], [x0,y0]=p(r1,a0),[x1,y1]=p(r1,a1),[x2,y2]=p(r0,a1),[x3,y3]=p(r0,a0),laf=(a1-a0)>Math.PI?1:0; return `M ${x0} ${y0} A ${r1} ${r1} 0 ${laf} 1 ${x1} ${y1} L ${x2} ${y2} A ${r0} ${r0} 0 ${laf} 0 ${x3} ${y3} Z`};
  const setCenter=(m,s)=>{main.textContent=m; sub.textContent=s;}
  const fmtPct=n=>n==null||isNaN(n)?'-':(n>=0?'+':'')+n.toFixed(2)+'%';
  const fmtN=n=>{if(n==null||isNaN(n))return'-'; const a=Math.abs(n); if(a>=1e12)return'$'+(n/1e12).toFixed(2)+'T'; if(a>=1e9)return'$'+(n/1e9).toFixed(2)+'B'; if(a>=1e6)return'$'+(n/1e6).toFixed(2)+'M'; return '$'+Number(n).toLocaleString('en-US',{maximumFractionDigits:2})};
  const list=(items,kind)=>`<div class="list">`+items.map((c,i)=>{const tk=(c.symbol||'').toUpperCase(), px=fmtN(c.current_price), pc=kind==='vol'?fmtN(c.total_volume):fmtPct(c.price_change_percentage_24h), cls=kind==='vol'?'':((c.price_change_percentage_24h||0)>=0?'up':'down'); return `<div class="row"><div class="rk">${i+1}</div><div class="tk">${tk}</div><div class="px">${px}</div><div class="pc ${cls}">${pc}</div></div>`}).join('')+`</div>`;
  const sparkMini=arr=>arr&&arr.length? sparkSVG(arr,180,44) : "";

  async function build(){
    // 데이터
    const rs=await Promise.allSettled([fetchMarkets(), fetchGlobal(), fetchFNG(), fetchBinanceLS('1h') , fetchMarketChart('bitcoin',7), fetchMarketChart('tether',7)]);
    const markets=rs[0].status==='fulfilled'?rs[0].value:[], global=rs[1].value?.data, fng=rs[2].value?.data?.[0], lsArr=rs[3].value, btcC=rs[4].value, usdtC=rs[5].value;
    const byId=Object.fromEntries(markets.map(m=>[m.id,m])); const btc=byId.bitcoin, usdt=byId.tether;
    const gainers=markets.filter(x=>Number.isFinite(x.price_change_percentage_24h)).sort((a,b)=>b.price_change_percentage_24h-a.price_change_percentage_24h).slice(0,10);
    const volTop=markets.slice().sort((a,b)=>b.total_volume-a.total_volume).slice(0,10);
    const dom=(global?.market_cap_percentage?.btc)||0;
    const ls=(()=>{const last=Array.isArray(lsArr)&&lsArr.length?lsArr.at(-1):null, ratio=Number(last?.longShortRatio||0)||0, shortPct=ratio?100/(1+ratio):50, longPct=100-shortPct; return {ratio,longPct,shortPct}})();

    // 허브 도넛
    svg.innerHTML=svg.innerHTML; // defs 유지
    const cx=500,cy=500,rO=470,rI=260,seg=TAU/7, start=-Math.PI/2;
    const defs=svg.querySelector('defs');
    // 공용 배경 그라디언트
    function segGrad(id){const g=document.createElementNS(svg.namespaceURI,'linearGradient'); g.id=id; g.setAttribute('x1','0');g.setAttribute('y1','0');g.setAttribute('x2','1');g.setAttribute('y2','1'); const s1=document.createElementNS(svg.namespaceURI,'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#7c3aed'); s1.setAttribute('stop-opacity','.55'); const s2=document.createElementNS(svg.namespaceURI,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#06b6d4'); s2.setAttribute('stop-opacity','.42'); g.appendChild(s1); g.appendChild(s2); defs.appendChild(g); }

    const secs=[
      {label:'롱/숏 (1H)', badge:`${ls.longPct.toFixed(0)}%`, centerTop:`${ls.longPct.toFixed(1)} / ${ls.shortPct.toFixed(1)}%`, centerSub:'롱/숏 (1H)',
        html:`<div>BTCUSDT 포지션 비율</div>
        <div style="margin-top:10px;height:10px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden"><div style="width:${ls.longPct.toFixed(1)}%;height:100%;background:#22c55e"></div></div>
        <div style="margin-top:8px;display:flex;justify-content:space-between"><div>Long ${ls.longPct.toFixed(1)}%</div><div>Short ${ls.shortPct.toFixed(1)}% · ratio ${ls.ratio.toFixed(2)}</div></div>`},
      {label:'BTC 도미넌스', badge:`${dom.toFixed(0)}%`, centerTop:`${dom.toFixed(2)}%`, centerSub:'도미넌스',
        html:`<div>BTC Dominance</div><div style="margin-top:6px">${dom.toFixed(2)}%</div>`},
      {label:'공포/탐욕', badge:fng?`${fng.value}`:'—', centerTop:fng?`${fng.value} / ${fng.value_classification}`:'—', centerSub:'공포/탐욕',
        html:`<div>Fear & Greed Index</div>
        <svg width="220" height="120" viewBox="0 0 220 120" style="margin-top:8px">${(()=>{const v=Number(fng?.value||0),pct=Math.max(0,Math.min(1,v/100)),cx=110,cy=100,r=72,start=Math.PI, end=0,ang=start+(end-start)*pct, arc=(a)=>`${cx+r*Math.cos(a)},${cy+r*Math.sin(a)}`;return `<path d="M ${arc(start)} A ${r} ${r} 0 0 1 ${arc(Math.PI/2)}" stroke="#ef4444" stroke-width="12" fill="none"/><path d="M ${arc(Math.PI/2)} A ${r} ${r} 0 0 1 ${arc(end)}" stroke="#22c55e" stroke-width="12" fill="none"/><line x1="${cx}" y1="${cy}" x2="${cx+(r-10)*Math.cos(ang)}" y2="${cy+(r-10)*Math.sin(ang)}" stroke="#fff" stroke-width="3" stroke-linecap="round"/>`})()}</svg>
        <div style="opacity:.85">${fng?`${fng.value} / ${fng.value_classification}`:'-'}</div>`},
      {label:'BTC 시총', badge:btc?fmtN(btc.market_cap):'—', centerTop:btc?fmtN(btc.market_cap):'—', centerSub:'BTC Market Cap',
        html:`<div>BTC Market Cap</div><div style="margin-top:6px">${btc?fmtN(btc.market_cap):'—'}</div>${btcC?`<div style="margin-top:8px">${sparkMini(btcC.market_caps?.map(x=>x[1]))}</div>`:''}`},
      {label:'USDT 시총', badge:usdt?fmtN(usdt.market_cap):'—', centerTop:usdt?fmtN(usdt.market_cap):'—', centerSub:'USDT Market Cap',
        html:`<div>USDT Market Cap</div><div style="margin-top:6px">${usdt?fmtN(usdt.market_cap):'—'}</div>${usdtC?`<div style="margin-top:8px">${sparkMini(usdtC.market_caps?.map(x=>x[1]))}</div>`:''}`},
      {label:'24H % TOP10 [USDT]', badge:'TOP10', centerTop:'+24H Gainers', centerSub:'USDT',
        html:`<div>24H % TOP10 [USDT]</div>${list(gainers,'pct')}`},
      {label:'거래량 TOP10', badge:'VOL', centerTop:'Volume Top10', centerSub:'24H',
        html:`<div>거래량 TOP10</div>${list(volTop,'vol')}`}
    ];

    secs.forEach((s,i)=>segGrad('g'+i));
    for(let i=0;i<secs.length;i++){
      const a0=start+seg*i+0.014, a1=start+seg*(i+1)-0.014;
      const path=document.createElementNS(svg.namespaceURI,'path');
      path.setAttribute('d',arc(cx,cy,260,470,a0,a1));
      path.setAttribute('fill',`url(#g${i})`); path.setAttribute('opacity','.92'); path.classList.add('hub-seg');
      svg.appendChild(path);
      // label
      const mid=(a0+a1)/2, rx=(260+470)/2, tx=cx+(rx-30)*Math.cos(mid), ty=cy+(rx-30)*Math.sin(mid)+6;
      const text=document.createElementNS(svg.namespaceURI,'text'); text.setAttribute('x',tx); text.setAttribute('y',ty); text.setAttribute('text-anchor','middle'); text.classList.add('hub-badge'); text.textContent=secs[i].badge; svg.appendChild(text);
      const act=()=>{svg.querySelectorAll('.hub-seg').forEach(el=>el.classList.remove('active')); path.classList.add('active'); setCenter(secs[i].centerTop, secs[i].centerSub); title.textContent=secs[i].label; content.innerHTML=secs[i].html;};
      path.addEventListener('mouseenter',()=>setCenter(secs[i].centerTop, secs[i].centerSub));
      path.addEventListener('click',act); text.addEventListener('click',act);
      if(i===0) act(); // 초기 선택
    }
  }
  build(); setInterval(build,60*1000);
})();

/* ===== Init ===== */
async function init(){
  // star slider
  const r=$("#starRange"); const apply=v=>document.documentElement.style.setProperty('--starVis', String(clamp(Number(v)/100,0,1))); apply(r.value); r.addEventListener('input',e=>apply(e.target.value));

  // data
  try{
    const rs=await Promise.allSettled([fetchMarkets(), fetchGlobal()]);
    state.all = rs[0].status==='fulfilled' ? rs[0].value : [];
    applyFilterSort();
  }catch{applyFilterSort()}

  // UI
  $("#search").addEventListener("input",e=>{state.filterQ=e.target.value||""; state.page=1; applyFilterSort();});
  wireHeaderSort();

  // refresh
  let vis=document.visibilityState==="visible";
  document.addEventListener("visibilitychange",()=>vis=document.visibilityState==="visible");
  setInterval(async ()=>{ if(!vis) return; try{const m=await fetchMarkets(); state.all=m; applyFilterSort();}catch{} }, 30000);
}
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
