<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tidewave Studio</title>
  <style>
    :root { --bg:#0b0f1a; --panel:#151a24; --txt:#e2e8f0; --mut:#9aa4b2; --acc:#6ee7ff; }
    html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,Segoe UI}
    body{background:var(--bg);color:var(--txt);display:grid;grid-template-columns:340px 1fr 520px;gap:10px}
    .left,.mid,.right{padding:10px}
    .left{background:var(--panel);display:flex;flex-direction:column;gap:10px}
    .mid{display:flex;flex-direction:column;gap:10px}
    .right{background:var(--panel);display:flex;flex-direction:column;gap:8px}
    .toolbar{display:flex;gap:6px;align-items:center}
    .toolbar input{flex:1;padding:8px;border-radius:8px;border:1px solid #2b3340;background:#0e131c;color:#cfd8e3}
    button{background:#1e2633;color:#cfd8e3;border:1px solid #2b3340;border-radius:8px;padding:7px 10px;cursor:pointer}
    button.primary{background:#0ea5e9;border-color:#0ea5e9;color:white}
    .chat{flex:1;overflow:auto;background:#0e131c;border-radius:10px;padding:8px}
    .msg{margin:6px 0}
    .msg.me   {text-align:right}
    .msg.me .bubble{background:#223049}
    .msg.ai .bubble{background:#1a2130}
    .bubble{display:inline-block;max-width:92%;padding:8px 10px;border-radius:10px}
    textarea#editor{flex:1;border:1px solid #2b3340;border-radius:10px;background:#0e131c;color:#e2e8f0;padding:10px;resize:none;height:360px}
    iframe{flex:1;border:1px solid #2b3340;border-radius:10px;background:#0e131c}
    .mut{color:var(--mut);font-size:12px}
    .row{display:flex;gap:8px;align-items:center}
    .ok{color:#34d399}
    .err{color:#ef4444}
    .kbd{font:12px/1 ui-monospace,Menlo,Consolas;background:#18202c;border:1px solid #2b3340;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <!-- LEFT: Chat with Claude -->
  <section class="left">
    <div class="row" style="justify-content:space-between">
      <div class="mut">Tidewave Studio · Claude</div>
      <button id="newChat">New</button>
    </div>
    <div id="chat" class="chat"></div>
    <div class="row">
      <input id="prompt" placeholder="무엇을 만들지 말해줘. 예: header.html의 히어로 문구와 스타일 개선" />
      <button id="send" class="primary">Send</button>
    </div>
    <div class="mut">Tip: <span class="kbd">/open apps/web/menu/header.html</span> · <span class="kbd">/save</span> · <span class="kbd">/commit 메시지</span></div>
  </section>

  <!-- MID: Live preview of your app -->
  <section class="mid">
    <div class="row">
      <div class="mut">Preview</div>
      <input id="url" value="http://localhost:3000/" />
      <button id="go">Go</button>
      <button id="refresh">Refresh</button>
    </div>
    <iframe id="frame" src="http://localhost:3000/"></iframe>
  </section>

  <!-- RIGHT: File open/edit/save/commit -->
  <section class="right">
    <div class="row">
      <input id="path" placeholder="apps/web/menu/index.html" />
      <button id="open">Open</button>
      <button id="save">Save</button>
    </div>
    <textarea id="editor" spellcheck="false"></textarea>
    <div class="row">
      <input id="msg" placeholder="커밋 메시지 (예: feat: update hero)" />
      <button id="push">Commit & Push</button>
    </div>
    <div id="status" class="mut"></div>
  </section>

  <script type="module">
    // ====== basic helpers ======
    const $ = (s)=>document.querySelector(s);
    const chat = $('#chat');
    const admin = localStorage.getItem('tw_admin_token') || prompt('ADMIN_TOKEN? (처음 한 번)');
    if(admin) localStorage.setItem('tw_admin_token', admin);
    const H = { 'Content-Type':'application/json', 'x-admin-token': admin };

    const state = {
      filePath: localStorage.getItem('tw_path') || 'apps/web/menu/index.html',
      lastAIText: ''
    };
    $('#path').value = state.filePath;

    function addMsg(role, text){
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.innerHTML = `<div class="bubble">${text.replaceAll('<','&lt;')}</div>`;
      chat.appendChild(div); chat.scrollTop = chat.scrollHeight;
    }
    function setStatus(html, cls=''){ $('#status').innerHTML = `<span class="${cls}">${html}</span>`; }

    async function readFile(p){
      const r = await fetch(`/api/file?path=${encodeURIComponent(p)}`);
      const j = await r.json();
      if(j.ok){ $('#editor').value = j.text; setStatus(`opened ${p}`, 'ok'); return j.text; }
      setStatus(j.error, 'err'); return '';
    }
    async function saveFile(){
      const p = $('#path').value.trim();
      const r = await fetch('/api/file/save',{ method:'POST', headers:H, body:JSON.stringify({ path:p, text:$('#editor').value })});
      const j = await r.json();
      if(j.ok){ setStatus('saved · ' + p, 'ok'); return true; }
      setStatus(j.error, 'err'); return false;
    }
    async function commitPush(){
      const msg = $('#msg').value.trim() || 'chore: update via studio';
      const r = await fetch('/api/git/commit',{ method:'POST', headers:H, body:JSON.stringify({ message:msg, paths:[ $('#path').value.trim() ]})});
      const j = await r.json();
      if(j.ok){ setStatus('pushed ✔', 'ok'); } else setStatus(j.error, 'err');
    }

    // ====== Claude chat ======
    async function askClaude(userText){
      addMsg('me', userText);
      const ctx = [
        `You are a code editor assistant for a Node/Express static site.`,
        `Current file path: ${state.filePath}`,
        `Return ONE of the following:`,
        `1) Full updated file content wrapped by <<<FILE>>> ... <<<END>>>`,
        `2) Plain answer.`,
        `If user asks to open a file: respond with <<<OPEN>>>path<<<END>>>`
      ].join('\n');

      // 현재 열려있는 파일 텍스트도 프롬프트에 포함
      const current = $('#editor').value;

      const body = {
        system: ctx,
        prompt: `USER:\n${userText}\n\nCURRENT_FILE_BEGIN\n${current}\nCURRENT_FILE_END`
      };
      const r = await fetch('/api/claude',{ method:'POST', headers:H, body:JSON.stringify(body)});
      const j = await r.json();
      if(!j.ok){ addMsg('ai', '❌ ' + (j.error||'error')); return; }

      const text = j.text || '';
      state.lastAIText = text;
      addMsg('ai', text);

      // 패턴 파싱: 열기/파일치환
      const open = text.match(/<<<OPEN>>>([\s\S]*?)<<<END>>>/);
      const file = text.match(/<<<FILE>>>([\s\S]*?)<<<END>>>/);

      if(open){
        const np = open[1].trim();
        $('#path').value = np; state.filePath = np; localStorage.setItem('tw_path', np);
        await readFile(np);
      }
      if(file){
        $('#editor').value = file[1]; setStatus('AI edit applied (not saved yet)');
      }
    }

    // ====== wire events ======
    $('#open').onclick   = async ()=>{ state.filePath = $('#path').value.trim(); localStorage.setItem('tw_path', state.filePath); await readFile(state.filePath); };
    $('#save').onclick   = saveFile;
    $('#push').onclick   = commitPush;
    $('#send').onclick   = async ()=>{
      const t = $('#prompt').value.trim(); if(!t) return;
      // slash commands
      if(t.startsWith('/open ')){ const p=t.slice(6).trim(); $('#path').value=p; state.filePath=p; await readFile(p); $('#prompt').value=''; return; }
      if(t.startsWith('/save')) { await saveFile(); $('#prompt').value=''; return; }
      if(t.startsWith('/commit')){ $('#msg').value=t.replace('/commit','').trim()||$('#msg').value; await commitPush(); $('#prompt').value=''; return; }
      await askClaude(t); $('#prompt').value='';
    };
    $('#newChat').onclick = ()=>{ chat.innerHTML=''; };
    $('#go').onclick      = ()=>{ $('#frame').src = $('#url').value.trim(); };
    $('#refresh').onclick = ()=>{ const f=$('#frame'); f.src = f.src; };

    // 초기 로딩
    await readFile(state.filePath);
  </script>
</body>
</html>
